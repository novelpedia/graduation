<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
    <link href="../css/edit.css" rel="stylesheet">
    <link href="../css/header.css" rel="stylesheet">
    <link href="../css/footer.css" rel="stylesheet">
    

    <title>작품 편집</title>
</head>

<body>
    <header class="header">
        <a class="logo_a" href="https://novelpedia.co.kr/">
            <!--<img class="logo" src="./image/novelpedia.png" height="40px">-->
            <img class="logo_icon" src="../image/logo.png">
        </a>
        <div class="first_line">
            <div class="inner_item">
                <a id="open_close" href="#" class="navbar_toggleBtn">
                    <img id="close" src="../image/메뉴_검정_버튼.png">
                </a>
                <div class="inner_inner_item">
                    <div class="search">
                        <div class="icon"></div>
                        <form method="get" action="../search">
                            <div class="input">
                                <input type="text" placeholder="Search" id="mysearch" name="q">
                            </div>
                            <span class="clear" onclick="document.getElementById('mysearch').value = ''"></span>
                            <input type="submit" value="" class="search_btn">
                        </form>
                    </div>
                </div>
            </div>
            <div class="set">
                <div class="set_mid">
                    <ul class="bar_menu">
                        <li><a href="../listpage.html">목록페이지</a></li>
                        <li class="mypage_header" id="mypage_button"><a href="../mypage">마이페이지</a></li>
                        <li><a href="../login" id="login_logout">Login</a></li>
                    </ul>
                </div>
            </div>
        </div>

    </header>

    <script>
        /*메뉴버튼 바꾸기 위한 변수*/
        const change_img = document.createElement('img');
        change_img.setAttribute('src', '../image/메뉴_닫힘.png');
        change_img.setAttribute('id', 'close');

        const change_img_normal = document.createElement('img');
        change_img_normal.setAttribute('src', '../image/메뉴_검정_버튼.png');
        change_img_normal.setAttribute('id', 'close');

        /*검색버튼에 대한 동작 변수*/
        const icon = document.querySelector('.search .icon');
        const search = document.querySelector('.search');
        const inner_item = document.querySelector('.inner_item');
        const inner_inner_item = document.querySelector('.inner_inner_item');
        const menu_window2 = document.querySelector('.header .set active');

        /*메뉴 버튼에 따른 동작 변수*/
        const toggleBtn = document.querySelector('.navbar_toggleBtn');
        const menu = document.querySelector('.bar_menu');
        const menu_window = document.querySelector('.header .set');

        /*메뉴버튼*/
        toggleBtn.onclick = function() {
            menu.classList.toggle('active');
            menu_window.classList.toggle('active');
            const lastDiv = document.getElementById('close');
            /*메뉴창 열림 여부에 따라 버튼 이미지 교체*/
            if (document.querySelector('.header .set').classList.contains('active')) {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img);
            } else {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img_normal);
            }

        }

        /*검색버튼*/
        icon.onclick = function() {
            icon.classList.toggle('active');
            search.classList.toggle('active');
            inner_item.classList.toggle('active');
            inner_inner_item.classList.toggle('active');
            menu_window.classList.toggle('search_active');
        }
    </script>

    <section class="document_item">
        <div class="document_name">
            <a href="#" id="document_name">작품제목(작가명)</a>
        </div>
        <div class="page_title">
            <h4>[문서 정보 편집]</h4>
        </div>
        <form action="#">
            <div class="document_critical_edit">
                <!--표지-->
                <div class="document_bookcover_edit">
                    <label for="bookcover_file">표지</label>
                    <img id="bookcover_preview" class="bookcover_preview" for="bookcover_file" src="../image/표지_미등록.png">
                    <input class="bookcover_upload" id="bookcover_file" type="file" accept="image/*" onchange="loadFile(this)">
                </div>
                <!--제목-->
                <div class="document_name_edit">
                    <label for="name">제목</label>
                    <input id="name" type="text" autocomplete="off">
                </div>
                <!--작가명-->
                <div class="document_author_edit">
                    <label for="author">작가</label>
                    <input id="author" type="text" autocomplete="off">
                </div>
                <!--생년월일-->
                <div class="document_birthday_edit">
                    <label for="birthday">작가 생년월일</label>
                    <div class="birthday_warning">
                        <input id="birthday" type="date" autocomplete="off">
                        <div class="checkbox_pakage">
                            <input id="birthday_check" type="checkbox" onclick="isCheck()">
                            <span> ※생년월일을 알 수 없는 경우 체크해주십시오※</span>
                        </div>
                    </div>
                </div>
                <!--출판사-->
                <div class="document_publisher_edit">
                    <label for="publisher">출판사</label>
                    <input id="publisher" type="text" autocomplete="off">
                </div>
                <!-- 분류선택 -->
                <!-- 장르 디자인 그대로 사용 -->
                <div class="document_genre_edit"> 
                    <label for="n_category">분류</label>
                    <select id="n_category">
                        <option></option>
                        <option>소설</option>
                        <option>만화</option>
                        <option>웹소설</option>
                        <option>웹툰</option>
                        <option>에세이</option>
                        <option>잡지</option>
                    </select>
                </div>
                <!--장르선택-->
                <div class="document_genre_edit">
                    <label for="genre">장르</label>
                    <select id="genre">
                        <option></option>
                        <option>일반</option>
                        <option>로맨스</option>
                        <option>판타지</option>
                        <option>로맨스판타지</option>
                        <option>현대판타지</option>
                        <option>무협</option>
                        <option>미스터리</option>
                        <option>코믹</option>
                    </select>
                </div>
                <!--구매처 및 연재처-->
                <div class="document_sale_edit">
                    <div class="sale_name">
                        <label for="sale_name">구매처 및 연재처</label>
                        <input id="sale_name" type="text" autocomplete="off">
                    </div>
                    <div class="sale_address">
                        <label for="sale_address">주소</label>
                        <input id="sale_address" type="text" autocomplete="off">
                    </div>
                </div>
                <!--출간일-->
                <div class="document_publishdate_edit">
                    <label for="publishdate">출간일</label>
                    <input id="publishdate" type="date" autocomplete="off">
                </div>
                <!--줄거리-->
                <div class="document_summary_edit">
                    <label for="summary">줄거리</label>
                    <textarea id="summary"></textarea>
                </div>
                <!--태그-->
                <div class="document_tag_edit">
                    <label for="tag">태그</label>
                    <div class="content">
                        <!--<p>Enter 키를 누르거나 쉼표(,) 키를 추가하십시오.</p>-->
                        <ul id="tag_area"><textarea id="tag" maxlength="50"></textarea></ul>
                        <div class="details">
                            <p><span>0</span> / 30</p>
                            <!--<button>모두 제거</button>-->
                        </div>
                    </div>
                </div>
                <!-- <div class="document_tag_edit">
                    <input id="tag" type="text" autocomplete="off">
                </div> -->
            </div>
            <!--사용자편집영역-->
            <div class="document_other_edit">
                <!--웹에디터 추가 영역-->
                <div class="webeditor">
                    <textarea id="document_other"></textarea>
                </div>
            </div>
            <!--각종버튼-->
            <div class="button_bundle">
                <input class="save" id="send" type="button" value="저장">
                <a onclick="history.back()">취소</a>
                <!--<input type="button" value="취소">-->
                <a class="delete" href="#">삭제</a>
            </div>
        </form>
    </section>

    <script>
        function loadFile(input) {
            var file = input.files[0];
            var changeImage = document.getElementById("bookcover_preview");
            changeImage.src = URL.createObjectURL(file);
        };
    </script>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="footer-col">
                    <ul>
                        <li><a href="#">공지사항</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">Q&A</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">의견보내기</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="../js/information.js"></script>

    <!--로그인 상태 체크-->
    <script src="../js/login_check.js"></script>
    <!--로그아웃을 위한 소스코드-->
    <script src="../js/logout.js"></script>
    <!--로그아웃 상태일 때-->
    <script src="../js/logout_state.js"></script>

    <!--태그 입력-->
    <script src="../js/tag.js"></script>

    <!-- 작성자 아이피주소 가져오기 -->
    <script>
        var ip_address_info;
        $.getJSON("https://ipinfo.io", function(data) {
            ip_address_info = data.ip;
        })
    </script>

    <script>
        const path_url = window.location.pathname;
        const path_decode = decodeURI(path_url);
        const document_name = path_decode.split('/');
        document.getElementById('document_name').innerText = document_name[2];
        document.getElementById("document_name").href = "../n/" + document_name[2];

        var document_bookcover = 'https://novelpedia2223-2ce3c.web.app/image/%ED%91%9C%EC%A7%80_%EB%AF%B8%EB%93%B1%EB%A1%9D.png';
        var document_version = 0;
        var document_the_first_date = new Date();
        var document_category = "n";

        // 타이틀 변경
        console.log(document_name[2]);
        document.title = document_name[2];
        
        db.collection('novel_document').doc(document_name[2]).get().then((결과) => {
            // 불러온 내용 바탕으로 내용 바꾸기
            console.log(결과.data())
            
            // DB에 저장되어있는 내용 가져와서 DB에 저장
            document_bookcover = 결과.data().bookcover;
            var document_information_title = 결과.data().name;
            var document_information_publisher = 결과.data().publisher;
            var document_information_author = 결과.data().author;
            var document_information_n_category = 결과.data().n_category;
            var document_information_genre = 결과.data().genre;
            var document_information_buy_series_name = 결과.data().buy_series;
            var document_information_buy_series_address = 결과.data().address;
            var document_information_publish_date = 결과.data().publish_date;
            var document_summary_content = 결과.data().summary;
            var document_information_birthday = 결과.data().author_birthday;
            
            
            // 추후에 입력, 순서대로 좋아요개수, 업로드 날짜, 조회수, 태그, 기타
            var document_like = 결과.data().like;
            var document_update_date = 결과.data().update_date;
            var document_view = 결과.data().view;
            var document_tag = 결과.data().tag;
            var document_other = 결과.data().other;
            document_version = 결과.data().version;
            document_the_first_date = 결과.data().the_first_date;
            document_category = 결과.data().category;

            if(document_information_birthday=='0001-01-01'){
                document.getElementById("birthday_check").checked = true;
            }
            else{
                document.getElementById("birthday_check").checked = false;                
            }

            // 타이틀 변경
            // document.title = document_name[2];
            
            // 편집, 역사 페이지 버튼 주소 초기화
            // document.getElementById("go_history").href = "../h/" + document_name[2];

            // 표지 미리보기 변경
            // console.log(document_bookcover);
            document.getElementById("bookcover_preview").src = document_bookcover;

            document.getElementById("name").value = document_information_title;
            document.getElementById("name").disabled = true;
            document.getElementById("author").value = document_information_author;
            document.getElementById("author").disabled = true;
            document.getElementById("birthday").value = document_information_birthday;
            document.getElementById("publisher").value = document_information_publisher;

            document.getElementById("n_category").value = document_information_n_category;
            document.getElementById("genre").value = document_information_genre
            
            document.getElementById("sale_name").value = document_information_buy_series_name;
            document.getElementById("sale_address").value = document_information_buy_series_address;

            document.getElementById("publishdate").value = document_information_publish_date;
            document.getElementById("summary").value = document_summary_content;

            // 태그 입력
            document_tag.forEach(function(tag_element){
                tags.push(tag_element);
            });
            countTags();
            createTag();
            // document.getElementById("tag").value = document_tag;
            document.getElementById("document_other").value = document_other;
        }).catch((err) => {
            console.log(err);
        });
    </script>

    <!-- 파이어베이스 데이터 등록 -->
    <script>
        const storage = firebase.storage();
        // 영어는 소문자로 저장
        var name_keyword_temp_lower = [];

        $('#send').click(function() {

            var file = document.querySelector('#bookcover_file').files[0];
            var storageRef = storage.ref();

            var name_keyword_temp = [
                ...$('#name').val().split(' '),
                ...$('#name').val().split('은'),
                ...$('#name').val().split('의'),
                ...$('#name').val().split('에'),
                ...$('#name').val().split('는'),
                ...$('#name').val().split('이'),
                ...$('#name').val().split('가'),
                ...$('#name').val().split('만'),
                ...$('#name').val().split('뿐'),
                ...$('#name').val().split('밖에'),
                ...$('#name').val().split('도'),
                ...$('#name').val().split('까지'),
                ...$('#name').val().split('마저'),
                ...$('#name').val().split('조차'),
                ...$('#name').val().split('은'),
                ...$('#name').val().split('나'),
                ...$('#name').val().split('이나'),
                ...$('#name').val().split('라도'),
                ...$('#name').val().split('이라도'),
                ...$('#name').val().split('든지'),
                ...$('#name').val().split('이든지'),
                ...$('#name').val().split('이나마'),
                ...$('#name').val().split('나마'),
                ...$('#name').val().split(','),
                ...$('#name').val().split('"'),
                ...$('#name').val().split('/'),
                ...$('#name').val().split('?'),
                ...$('#name').val().split('!'),
                ...$('#name').val().split('@'),
                ...$('#name').val().split('#'),
                ...$('#name').val().split('$'),
                ...$('#name').val().split('%'),
                ...$('#name').val().split('^'),
                ...$('#name').val().split('&'),
                ...$('#name').val().split('*'),
                ...$('#name').val().split('('),
                ...$('#name').val().split(')'),
                ...$('#name').val().split('-'),
                ...$('#name').val().split('_'),
                ...$('#name').val().split('+'),
                ...$('#name').val().split('='),
                ...$('#name').val().split('<'),
                ...$('#name').val().split('>'),
                ...$('#name').val().split('.'),
                ...$('#name').val().split('|'),
                ...$('#name').val().split('`'),
                ...$('#name').val().split('~'),
                ...$('#name').val().split('['),
                ...$('#name').val().split(']'),
                ...$('#name').val().split('{'),
                ...$('#name').val().split('}'),
                ...$('#name').val().split('」'),
                ...$('#name').val().split('「'),
                ...$('#name').val().split(', '),
                ...$('#name').val().split("'"),
                ...$('#name').val().split('1'),
                ...$('#name').val().split('2'),
                ...$('#name').val().split('3'),
                ...$('#name').val().split('4'),
                ...$('#name').val().split('5'),
                ...$('#name').val().split('6'),
                ...$('#name').val().split('7'),
                ...$('#name').val().split('8'),
                ...$('#name').val().split('9'),
                ...$('#name').val().split('0')
            ];
            // console.log(name_keyword_temp);

            // 중복체크
            name_keyword_temp = [...new Set(name_keyword_temp)];

            var name_keyword_temp2 = [];

            // 구분 다시한번 실행
            name_keyword_temp.forEach(element => {
                element.split(' ').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('은').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('의').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('에').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('는').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('이').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('가').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('만').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('뿐').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('밖에').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('도').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('까지').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('마저').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('조차').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('은').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('나').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('이나').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('라도').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('이라도').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('이든지').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('든지').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('이나마').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('나마').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split(',').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('"').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('/').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('?').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('!').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('@').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('#').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('$').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('%').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('^').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('&').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('*').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('(').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split(')').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('-').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('+').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('=').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('<').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('>').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('.').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('|').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('`').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('~').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('[').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split(']').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('{').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('}').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('「').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('」').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split(', ').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split("'").forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('1').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('2').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('3').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('4').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('5').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('6').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('7').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('8').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('9').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
                element.split('0').forEach(temp =>{
                    name_keyword_temp2.push(temp);
                });
            });

            name_keyword_temp2 = [...new Set(name_keyword_temp2)];
            console.log(name_keyword_temp2);

            
            name_keyword_temp2.forEach(element => {
                if(element.length === 0){
                }
                else{
                    name_keyword_temp_lower.push(element.toLowerCase().replace(/ /g, ''));
                }
            });

            // 원래 제목 맨 앞에 추가
            name_keyword_temp_lower.unshift($('#name').val().toLowerCase().replace(/ /g, ''));
            // 중복체크
            name_keyword_temp_lower = [...new Set(name_keyword_temp_lower)];

            // 첨부파일 여부 확인
            var bookcover_chk = document.getElementById("bookcover_file").value;

            var docRef = db.collection('novel_document').doc($('#name').val() + "(" + $('#author').val() + ")");

            // 첨부파일에 이미지가 없는 경우
            if(bookcover_chk.length === 0) {
                var dt = new Date();
                console.log("이미지없음 실행");
                if ($('#name').val().length === 0) {
                        alert("제목이 입력되지 않았습니다.");
                    } else if ($('#author').val().length === 0) {
                        alert("작가명이 입력되지 않았습니다.");
                    } else if ($('#birthday').val().length === 0) {
                        alert("생년월일이 입력되지 않았습니다.");
                    } else if ($('#publisher').val().length === 0) {
                        alert("출판사 정보가 입력되지 않았습니다.");
                    } else if ($('#n_category').val().length === 0) {
                        alert("분류가 선택되지 않았습니다.");
                    } else if ($('#genre').val().length === 0) {
                        alert("장르가 선택되지 않았습니다.");
                    } else if ($('#sale_name').val().length === 0) {
                        alert("구매처 또는 연재처를 입력해주세요.");
                    } else if ($('#sale_address').val().length === 0) {
                        alert("구매처 또는 연재처의 주소를 입력해주세요. ex)서울특별시 중구... 또는 http://yes24.com");
                    } else if ($('#publishdate').val().length === 0) {
                        alert("출간일이 입력되지 않았습니다.");
                    } else if ($('#summary').val().length === 0) {
                        alert("줄거리가 입력되지 않았습니다.");
                    } else {
                        return docRef.update({
                            name: $('#name').val(),
                            name_keyword: name_keyword_temp_lower,
                            author: $('#author').val(),
                            author_birthday : $('#birthday').val(),
                            publisher: $('#publisher').val(),
                            n_category: $('#n_category').val(),
                            genre: $('#genre').val(),
                            buy_series: $('#sale_name').val(),
                            address: $('#sale_address').val(),
                            publish_date: $('#publishdate').val(),
                            tag: tags,
                            summary: $('#summary').val(),
                            other: $('#document_other').val(),
                            version: firebase.firestore.FieldValue.increment(1),
                            update_date:dt,
                            final_modify: ip_address_info
                        })
                        .then(() => {
                            history(document_bookcover);
                            // console.log("Document successfully updated!");
                            
                        })
                        .catch((error) => {
                            // The document probably doesn't exist.
                            // 새문서의 경우
                            console.error("Error updating document: ", error);
                            var info = {
                                bookcover: 'https://novelpedia2223-2ce3c.web.app/image/%ED%91%9C%EC%A7%80_%EB%AF%B8%EB%93%B1%EB%A1%9D.png',
                                name: $('#name').val(),
                                name_keyword: name_keyword_temp_lower,
                                author: $('#author').val(),
                                author_birthday : $('#birthday').val(),
                                publisher: $('#publisher').val(),
                                n_category: $('#n_category').val(),
                                genre: $('#genre').val(),
                                buy_series: $('#sale_name').val(),
                                address: $('#sale_address').val(),
                                publish_date: $('#publishdate').val(),
                                tag: tags,
                                summary: $('#summary').val(),
                                like: 0,
                                view: 0,
                                star:0,
                                version:1,
                                other: $('#document_other').val(),
                                update_date:dt,
                                the_first_date:dt,
                                category:"n",
                                final_modify: ip_address_info
                            };
                            docRef.set(info).then((result) => {
                                history(document_bookcover);
                                // console.log(tags);
                                // console.log(result);
                                // alert("success.");
                            }).catch(() => {
                                alert("failed.");
                            });
                        });
                    }
            }
            else{
                console.log("이미지있음 실행");
                var dt = new Date();
                var dt_temp = dt.getFullYear() + (String)(dt.getMonth()+1) + dt.getDate() + dt.getHours() + dt.getMinutes() + dt.getSeconds() + dt.getMilliseconds();
                console.log(dt_temp);
                var save_path = storageRef.child('image/' + dt_temp + file.name);
                var uploading = save_path.put(file);

                if ($('#name').val().length === 0) {
                    alert("제목이 입력되지 않았습니다.");
                } else if ($('#author').val().length === 0) {
                    alert("작가명이 입력되지 않았습니다.");
                } else if ($('#birthday').val().length === 0) {
                    alert("생년월일이 입력되지 않았습니다.");
                } else if ($('#publisher').val().length === 0) {
                    alert("출판사 정보가 입력되지 않았습니다.");
                } else if ($('#n_category').val().length === 0) {
                    alert("분류가 선택되지 않았습니다.");
                } else if ($('#genre').val().length === 0) {
                    alert("장르가 선택되지 않았습니다.");
                } else if ($('#sale_name').val().length === 0) {
                    alert("구매처 또는 연재처를 입력해주세요.");
                } else if ($('#sale_address').val().length === 0) {
                    alert("구매처 또는 연재처의 주소를 입력해주세요. ex)서울특별시 중구... 또는 http://yes24.com");
                } else if ($('#publishdate').val().length === 0) {
                    alert("출간일이 입력되지 않았습니다.");
                } else if ($('#summary').val().length === 0) {
                    alert("줄거리가 입력되지 않았습니다.");
                } else{
                    uploading.on('state_changed',
                        null,
                        (error) => {
                            console.error('fail reason: ', error);
                        },

                        () => {
                            uploading.snapshot.ref.getDownloadURL().then((url) => {
                                return docRef.update({
                                    bookcover: url,
                                    name: $('#name').val(),
                                    author: $('#author').val(),
                                    author_birthday : $('#birthday').val(),
                                    publisher: $('#publisher').val(),
                                    n_category: $('#n_category').val(),
                                    genre: $('#genre').val(),
                                    buy_series: $('#sale_name').val(),
                                    address: $('#sale_address').val(),
                                    publish_date: $('#publishdate').val(),
                                    tag: tags,
                                    summary: $('#summary').val(),
                                    other: $('#document_other').val(),
                                    version: firebase.firestore.FieldValue.increment(1),
                                    update_date:dt,
                                    final_modify: ip_address_info
                                })
                                .then(() => {
                                    history(url);
                                    console.log("Document successfully updated!");
                                })
                                .catch((error) => {
                                    // The document probably doesn't exist.
                                    console.error("Error updating document: ", error);
                                        var info = {
                                            bookcover: url,
                                            name: $('#name').val(),
                                            name_keyword: name_keyword_temp_lower,
                                            author: $('#author').val(),
                                            author_birthday : $('#birthday').val(),
                                            publisher: $('#publisher').val(),
                                            n_category: $('#n_category').val(),
                                            genre: $('#genre').val(),
                                            buy_series: $('#sale_name').val(),
                                            address: $('#sale_address').val(),
                                            publish_date: $('#publishdate').val(),
                                            tag: tags,
                                            summary: $('#summary').val(),
                                            like: 0,
                                            view: 0,
                                            star:0,
                                            version:1,
                                            other: $('#document_other').val(),
                                            the_first_date: dt,
                                            update_date:dt,
                                            category:"n",
                                            final_modify: ip_address_info                                
                                        };
                                        docRef.set(info).then((result) => {
                                            console.log(result);
                                            history(url);
                                            // window.location.reload();
                                        }).catch(() => {
                                            alert("failed.");
                                        });
                                    
                                });
                            })
                        }
                    )
                }
            }
            // 입력여부 확인, 태그는 입력하지 않아도 통과
            
        })
    </script>

    <!-- 역사_초기화 -->
    <script>        
        function history(url = "https://novelpedia2223-2ce3c.web.app/image/%ED%91%9C%EC%A7%80_%EB%AF%B8%EB%93%B1%EB%A1%9D.png") {
            var docRefHistory = db.collection('history').doc($('#name').val() + "(" + $('#author').val() + ")");
            var subHistory = docRefHistory.collection('version').doc((document_version + 1).toString());
            var info = {
                bookcover: url,
                name: $('#name').val(),
                name_keyword: name_keyword_temp_lower,
                author: $('#author').val(),
                author_birthday : $('#birthday').val(),
                publisher: $('#publisher').val(),
                n_category: $('#n_category').val(),
                genre: $('#genre').val(),
                buy_series: $('#sale_name').val(),
                address: $('#sale_address').val(),
                publish_date: $('#publishdate').val(),
                tag: tags,
                summary: $('#summary').val(),
                version: document_version + 1,
                other: $('#document_other').val(),
                the_first_date: document_the_first_date,
                update_date:new Date(),
                category:document_category,
                final_modify: ip_address_info                               
            };
            subHistory.set(info).then((result) => {
                console.log(result);
                alert("history success.");
                window.location.href='../n/' + $('#name').val() + "(" + $('#author').val() + ")";
            }).catch((error) => {
                console.log(error);
                alert("history failed.");
            });
        }
    </script>

    <script>
        function isCheck(){
            var check = document.getElementById('birthday_check').checked;

            if(check == true){
                document.getElementById("birthday").value = '0001-01-01';
                document.getElementById("birthday").disabled = true;
            }
            else{
                document.getElementById("birthday").value = "";
                document.getElementById("birthday").disabled = false;
            }
        }
    </script>

    
</body>

</html>