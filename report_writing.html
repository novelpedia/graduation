
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
    <link href="css/header.css" rel="stylesheet">
    <link href="css/footer.css" rel="stylesheet">
    <link href="css/report_writing.css" rel="stylesheet">
    <title>글쓰기</title>
</head>
<body>
    <header class="header">
        <a class="logo_a" href="http://novelpedia.co.kr">
            <!--<img class="logo" src="./image/novelpedia.png" height="40px">-->
            <img class="logo_icon" src="image/logo.png">
        </a>
        <div class="first_line">
            <div class="inner_item">
                <a id="open_close" href="#" class="navbar_toggleBtn">
                    <img id="close" src="image/메뉴_검정_버튼.png">
                </a>
                <div class="inner_inner_item">
                    <div class="search">
                        <div class="icon"></div>
                        <form method="get" action="search">
                            <div class="input">
                                <input type="text" placeholder="Search" id="mysearch" name="q">
                            </div>
                            <span class="clear" onclick="document.getElementById('mysearch').value = ''"></span>
                            <input type="submit" value="" class="search_btn">
                        </form>
                    </div>
                </div>
            </div>
            <div class="set">
                <div class="set_mid">
                    <ul class="bar_menu">
                        <input type="checkbox" id="list_open">
                        <label for="list_open" class="list_page_label">
                            <li class="list_li">목록페이지</li>
                            <div class="header_list">
                                <div class="header_set1">
                                    <div class="header_picture"><a href="list/novel">작품</a></div>
                                </div>
                                <div class="header_set1">
                                    <div class="header_author"><a href="list/author">작가</a></div>
                                </div>
            
                                <div class="header_set1">
                                    <div class="header_publisher"><a href="list/publisher">출판사</a></div>
                                </div>
                            </div>
                        </label>
                        <li class="mypage_header" id="mypage_button"><a href="mypage">마이페이지</a></li>
                        <li><a href="login" id="login_logout">Login</a></li>
                    </ul>
                </div>
            </div>
        </div>

    </header>

    <script>
        /*메뉴버튼 바꾸기 위한 변수*/
        const change_img = document.createElement('img');
        change_img.setAttribute('src', './image/메뉴_닫힘.png');
        change_img.setAttribute('id', 'close');

        const change_img_normal = document.createElement('img');
        change_img_normal.setAttribute('src', './image/메뉴_검정_버튼.png');
        change_img_normal.setAttribute('id', 'close');

        /*검색버튼에 대한 동작 변수*/
        const icon = document.querySelector('.search .icon');
        const search = document.querySelector('.search');
        const inner_item = document.querySelector('.inner_item');
        const inner_inner_item = document.querySelector('.inner_inner_item');
        const menu_window2 = document.querySelector('.header .set active');

        /*메뉴 버튼에 따른 동작 변수*/
        const toggleBtn = document.querySelector('.navbar_toggleBtn');
        const menu = document.querySelector('.bar_menu');
        const menu_window = document.querySelector('.header .set');

        /*메뉴버튼*/
        toggleBtn.onclick = function() {
            menu.classList.toggle('active');
            menu_window.classList.toggle('active');
            const lastDiv = document.getElementById('close');
            /*메뉴창 열림 여부에 따라 버튼 이미지 교체*/
            if (document.querySelector('.header .set').classList.contains('active')) {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img);
            } else {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img_normal);
            }

        }

        /*검색버튼*/
        icon.onclick = function() {
            icon.classList.toggle('active');
            search.classList.toggle('active');
            inner_item.classList.toggle('active');
            inner_inner_item.classList.toggle('active');
            menu_window.classList.toggle('search_active');
        }
    </script>

    <section class="section_all">
        <div class="banner"><a href="report_list.html">신고 및 건의</a></div>
        <div class="report_container">
            <div class="box">
                <label for="name">제목</label>
                <input type="text" id="name" name="name">
            </div>
            <div class="category_list">
                <input type="radio" id="report" name="choice1" value="r">
                <label for="report">신고</label><br>
                <input type="radio" id="suggestion" name="choice1" value="s">
                <label for="suggestion">건의</label><br>
            </div>
            <textarea class="content" id="content"></textarea>
            <div class="top">
                <a href="javascript:;" class="register" id="register">등록</a>
                <a href="report_list.html" class="cancel">취소</a>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="footer-col">
                    <ul>
                        <li><a href="/notice">공지사항</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="/report">신고 및 건의</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">의견보내기</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!--파이어베이스 연동 자바스크립트 파일-->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <!--제이쿼리-->
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    
    <!--파이어베이스 정보 가져오기--><!--파이어베이스 연동 키값-->
    <script src="./js/information.js"></script>

    <!--로그인 상태 체크-->
    <script src="./js/login_check.js"></script>
    <!--로그아웃을 위한 소스코드-->
    <script src="./js/logout.js"></script>
    <!--로그아웃 상태일 때-->
    <script src="./js/logout_state.js"></script>

    <script>
        $(document).ready(function() {
            var number = getParameterByName("page");
            // number 값 null일 때, 새로운 신고 및 건의 등록
            if (number == null) {
                // 등록 버튼 클릭했을 때 실행
                $(".register").on("click", function() {
                    // var user_id = login_user_information 제거
                    console.log("user_id : " + user_id);

                    if (login_check == true) {
                        var category = $("input[name='choice1']:checked").val();
                        // 새로운 변수 생성
                        var name = $("#name").val();
                        var content = $(".content").val();

                        // 모든 값이 작성되었을 때
                        if (name !== '' && content !== '' && category !== undefined) {

                            // 신고 및 건의 중 가장 큰 number 값 찾기
                            var maxNum = 0;
                            db.collection("report")
                                .orderBy("number", "desc")
                                .limit(1)
                                .get()
                                .then(function(querySnapshot) {
                                querySnapshot.forEach(function(doc) {
                                    maxNum = doc.data().number;
                                });
                                // 새로운 변수 생성
                                var newNum = maxNum + 1;
                                var view = 0;
                                var timestamp = firebase.firestore.Timestamp.fromDate(new Date());
                                var created_at = timestamp.toDate(); // 최초 작성 시간
                                var updated_at = created_at; // 최초 작성 시간이므로 수정 시간도 최초 작성 시간과 같습니다.

                                // 신고 및 건의 db에 추가
                                db.collection("report")
                                    .add({
                                    user_id : user_id,
                                    name: name,
                                    content: content,
                                    created_at: created_at,
                                    updated_at: updated_at,
                                    view: view,
                                    number: newNum,
                                    category: category // 선택된 카테고리 값 추가
                                    })
                                    .then(function(docRef) {
                                    console.log("ID로 작성된 문서: ", docRef.id);
                                    alert("신고 및 건의 등록되었습니다.");
                                    location.href = "report_list.html"; // 새로 등록할 때는 목록 페이지로 이동
                                    })
                                    .catch(function(error) {
                                    console.error("문서 추가 오류: ", error);
                                    });
                                })
                                .catch(function(error) {
                                console.log("문서를 가져오는 중 오류 발생: ", error);
                                });
                        }
                    } else {
                        $("#register").remove(); // 등록(수정) 버튼 제거
                        // 로그인하지 않은 유저는 경고 메시지를 출력합니다.
                        console.log("로그인하지 않은 유저입니다.");
                        alert("로그인하지 않은 유저입니다. 로그인 후 이용해주세요.");
                    }
                });
            }else { // number 값 이미 있을 때, 신고 및 건의 수정
                // 제목, 내용 가져와서 미리 채우기
                db.collection("report").where("number", "==", parseInt(number))
                    .get()
                    .then(function(querySnapshot) {
                        querySnapshot.forEach(function(doc) {
                            var user_id = doc.data().user_id;
                            var name = doc.data().name;
                            var content = doc.data().content;
                            $("#name").val(name);
                            $("#content").val(content);

                            // 신고와 건의 라디오 버튼 체크 상태 유지
                            const category = doc.data().category.toLowerCase();

                            if (category === "r") { // 신고 체크
                                $('input:radio[name="choice1"][value="r"]').prop('checked', true); // 해당 라디오 버튼을 체크된 상태로 변경
                                $('input:radio[name="choice2"][value="s"]').prop('checked', false);// 해당 라디오 버튼을 체크 X
                            } else if (category === "s") { // 건의 체크
                                $('input:radio[name="choice2"][value="s"]').prop('checked', true); // 해당 라디오 버튼을 체크된 상태로 변경
                                $('input:radio[name="choice1"][value="r"]').prop('checked', false);// 해당 라디오 버튼을 체크 X
                            } else { // 체크 해제
                                $('input:radio[name="choice1"]').prop('checked', false);
                                $('input:radio[name="choice2"]').prop('checked', false);
                            }
                            // 라디오 버튼 중 하나가 클릭되면, 클릭된 라디오 버튼을 제외한 나머지 체크 해제
                            $('input[type="radio"]').on('click', function() {
                                if ($(this).prop('checked')) {
                                    $(this).siblings().prop('checked', false);
                                }
                            });

                            // 등록(수정) 버튼 클릭했을 때 실행
                            $(".register").on("click", function() {
                                if (login_check == true && user_id === doc.data().user_id) {
                                    // 입력한 내용 가져오기
                                    var name = $("#name").val();
                                    var content = $("#content").val();
                                    // 신고 or 건의 값을 가져오는 category
                                    var category = $("input[name='choice1']:checked").val() || $("input[name='choice2']:checked").val();
                                    
                                    // 모든 값이 작성되었을 때
                                    if (name !== '' && content !== '' && category !== undefined) {
                                    
                                        var timestamp = firebase.firestore.Timestamp.fromDate(new Date());
                                        // 문서 업데이트
                                        db.collection("report").doc(doc.id).update({
                                            name: name,
                                            content: content,
                                            category: category,
                                            updated_at: timestamp // 최종 수정 시간 기록
                                        })
                                        .then(function() {
                                            console.log("문서가 성공적으로 업데이트되었습니다!");
                                            alert("신고 및 건의 수정되었습니다.");
                                            location.href = "report_view.html?page=" + number;
                                        })
                                        .catch(function(error) {
                                            console.error("문서 업데이트 오류: ", error);
                                        });
                                    }
                                } else {
                                    $("#register").remove(); // 등록(수정) 버튼 제거
                                    // 로그인하지 않은 유저는 경고 메시지를 출력합니다.
                                    console.log("글 작성자가 아닙니다.");
                                    alert("글 작성자가 아닙니다.");
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log("문서를 가져오는 중 오류 발생: ", error);
                    });
            }
        });
    </script>

    <!-- caught ReferenceError  에러 발생해서 getParameterByName 함수를 정의 -->
    <script>
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
    </script>
</body>
</html>