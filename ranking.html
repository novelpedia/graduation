<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/ranking.css" rel="stylesheet">
    <link href="css/header.css" rel="stylesheet">
    <link href="css/footer.css" rel="stylesheet">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
    <title>노벨피디아 순위</title>
</head>

<body>
    <header class="header">
        <a class="logo_a" href="http://novelpedia.co.kr">
            <!--<img class="logo" src="./image/novelpedia.png" height="40px">-->
            <img class="logo_icon" src="image/logo.png">
        </a>
        <div class="first_line">
            <div class="inner_item">
                <a id="open_close" href="#" class="navbar_toggleBtn">
                    <img id="close" src="image/메뉴_검정_버튼.png">
                </a>
                <div class="inner_inner_item">
                    <div class="search">
                        <div class="icon"></div>
                        <form method="get" action="search">
                            <div class="input">
                                <input type="text" placeholder="Search" id="mysearch" name="q">
                            </div>
                            <span class="clear" onclick="document.getElementById('mysearch').value = ''"></span>
                            <input type="submit" value="" class="search_btn">
                        </form>
                    </div>
                </div>
            </div>
            <div class="set">
                <div class="set_mid">
                    <ul class="bar_menu">
                        <input type="checkbox" id="list_open">
                        <label for="list_open" class="list_page_label">
                            <li class="list_li">목록페이지</li>
                            <div class="header_list">
                                <div class="header_set1">
                                    <div class="header_picture"><a href="list/novel">작품</a></div>
                                </div>
                                <div class="header_set1">
                                    <div class="header_author"><a href="list/author">작가</a></div>
                                </div>
            
                                <div class="header_set1">
                                    <div class="header_publisher"><a href="list/publisher">출판사</a></div>
                                </div>
                            </div>
                        </label>
                        <li class="mypage_header" id="mypage_button"><a href="mypage">마이페이지</a></li>
                        <li><a href="login" id="login_logout">Login</a></li>
                    </ul>
                </div>
            </div>
        </div>

    </header>

    <script>
        /*메뉴버튼 바꾸기 위한 변수*/
        const change_img = document.createElement('img');
        change_img.setAttribute('src', './image/메뉴_닫힘.png');
        change_img.setAttribute('id', 'close');

        const change_img_normal = document.createElement('img');
        change_img_normal.setAttribute('src', './image/메뉴_검정_버튼.png');
        change_img_normal.setAttribute('id', 'close');

        /*검색버튼에 대한 동작 변수*/
        const icon = document.querySelector('.search .icon');
        const search = document.querySelector('.search');
        const inner_item = document.querySelector('.inner_item');
        const inner_inner_item = document.querySelector('.inner_inner_item');
        const menu_window2 = document.querySelector('.header .set active');

        /*메뉴 버튼에 따른 동작 변수*/
        const toggleBtn = document.querySelector('.navbar_toggleBtn');
        const menu = document.querySelector('.bar_menu');
        const menu_window = document.querySelector('.header .set');

        /*메뉴버튼*/
        toggleBtn.onclick = function() {
            menu.classList.toggle('active');
            menu_window.classList.toggle('active');
            const lastDiv = document.getElementById('close');
            /*메뉴창 열림 여부에 따라 버튼 이미지 교체*/
            if (document.querySelector('.header .set').classList.contains('active')) {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img);
            } else {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img_normal);
            }

        }

        /*검색버튼*/
        icon.onclick = function() {
            icon.classList.toggle('active');
            search.classList.toggle('active');
            inner_item.classList.toggle('active');
            inner_inner_item.classList.toggle('active');
            menu_window.classList.toggle('search_active');
        }
    </script>

    <section class="section_all">
        <div class="box_section">
            <div class="banner_ranking">
                <a href="#">노벨피디아 순위</a>
            </div>
            <div class="first_category_tab">
                <input type="radio" id="select1" name="choice1" value="t_novel" checked onclick="enable_Review(); enable_AuthorPublisher();"><label for="select1">작품</label>
                <input type="radio" id="select2" name="choice1" value="t_author" onclick="disable_Review(); disable_AuthorPublisher();"><label for="select2">작가</label>
                <input type="radio" id="select3" name="choice1" value="t_publisher" onclick="disable_Review(); disable_AuthorPublisher();"><label for="select3">출판사</label>
            </div>
            <div class="second_sort_tab">
                <input type="radio" id="select4" name="choice2" value="t_view" checked onclick="enable_AuthorPublisher();"><label for="select4">조회 수</label>
                <input type="radio" id="select5" name="choice2" value="t_like" onclick="enable_AuthorPublisher();"><label for="select5">좋아요 수</label>
                <input type="radio" id="select6" name="choice2" value="t_review" onclick="enable_Review(); disable_AuthorPublisher();"><label for="select6">리뷰 수</label>
            </div>
        
            <div id="content">
                <div class="novel_rank">
                    <ul class="novel_top_rank">
                        <!-- <li>
                            <div class="top_numb">
                                <span class="top_num">
                                    <em class="1">1</em>
                                </span>
                            </div>
                            <a href="" class="image">
                                <img src="./image/표지_미등록.png">
                            </a>
                            <div class="novel_cont">
                                <h3>
                                    <a href="">소설제목</a>
                                </h3>
                                <p class="info">
                                    <span class="score">
                                        <span style="">평점</span>
                                    </span>
                                </p>
                                <p class="summary">줄거리</p>
                            </div>
                        </li> -->
                    </ul>
                </div>
            </div>
    </section>

    <script>
        window.onload = function() {
            let collection_name = 'novel_document'; // 초기값 설정
            let select_name = 'view'; // 초기값 설정

            updateList(); // 페이지 로드

            // 라디오 버튼 클릭 이벤트 리스너
            const radio_val = document.getElementsByName('choice1'); 
            for(let i=0; i<radio_val.length; i++){
                radio_val[i].addEventListener('click', function(){
                    // 선택된 라디오 버튼 값
                    let select_val = document.querySelector('input[name="choice1"]:checked').value;

                    // 선택된 라디오 값에 따라 컬렉션 이름 변경
                    if(select_val === 't_novel'){
                        collection_name = 'novel_document';
                    } else if (select_val === 't_author'){
                        collection_name = 'author_document';
                    } else if (select_val ==='t_publisher'){
                        collection_name = 'publisher_document';
                    }
                    updateList();
                });
                
            }
                    
            const radio_val2 = document.getElementsByName('choice2'); 
            for(let j=0; j<radio_val2.length; j++){
                radio_val2[j].addEventListener('click', function(){
                    let select_val2 = document.querySelector('input[name="choice2"]:checked').value;
                    
                    if(select_val2 == 't_view'){
                        select_name = 'view';
                    } else if(select_val2 == 't_like'){
                        select_name = 'like';
                    } else if(select_val2 == 't_review'){
                        select_name = 'star_count'
                    }
                    updateList();
                });
            }
            // 데이터 출력
            function updateList() {
                db.collection(collection_name).orderBy(select_name, 'desc').limit(10).get().then((querySnapshot) => {

                    $('.novel_top_rank').empty();
                    let number = 1; // 순위 번호
                    querySnapshot.forEach((doc) => {
                        // 작품(사진, 소설제목(작가) 링크, 평점, 줄거리요약)
                        if(collection_name == 'novel_document'){ 
                            let summary = doc.data().summary;
                            let star_score = doc.data().star / doc.data().star_count; // 별점

                            // 별점이 없는 경우
                            if(doc.data().star <= 0 || doc.data().star_count <= 0 || doc.data().star == null){
                                star_score = 0;
                            }

                            var star_score_s

                            if(star_score==0){
                                star_score_s = star_score + ".0";
                            }
                            else if(star_score==1){
                                star_score_s = star_score + ".0";
                            }
                            else if(star_score==2){
                                star_score_s = star_score + ".0";
                            }
                            else if(star_score==3){
                                star_score_s = star_score + ".0";
                            }
                            else if(star_score==4){
                                star_score_s = star_score + ".0";
                            }
                            else if(star_score==5){
                                star_score_s = star_score + ".0";
                            }
                            else{
                                star_score_s = star_score;
                            }

                            // 만약 줄거리가 없는 경우 빈칸
                            if(summary == null || summary == undefined){
                                summary = '';
                            }
                            if(summary.length >= 80){
                                summary = summary.substr(0, 80) + "⋯";
                            }

                            var temp = `
                                    <li>
                                        <div class="top_numb">            
                                            <span class="top_num">
                                                <em class="1">${number}</em>
                                            </span>
                                        </div>
                                        <a href="https://novelpedia.co.kr/n/${doc.data().name+"("+doc.data().author+")"}" class="image">
                                            <img src="${doc.data().bookcover}">
                                        </a>
                                        <div class="novel_cont">
                                            <h3>
                                                <a href="https://novelpedia.co.kr/n/${doc.data().name+"("+doc.data().author+")"}">${doc.data().name + "(" + doc.data().author + ")"}</a>
                                            </h3>
                                            <p class="info">
                                                <span class="score">
                                                    <span style="">${star_score_s}</span>
                                                </span>
                                            </p>
                                            <p class="summary">${summary}</p>
                                        </div>
                                    </li>`;
                            number++; // 순위 번호 증가
                            $('.novel_top_rank').append(temp);
                        }
                        
                        // 작가(사진, 최근작품명(작가명) 링크
                        if(collection_name == 'author_document'){ 
                            var temp = `
                                    <li>
                                        <div class="top_numb">            
                                            <span class="top_num">
                                                <em class="1">${number}</em>
                                            </span>
                                        </div>
                                        <a href="https://novelpedia.co.kr/a/${doc.data().name + "(" + doc.data().birthday + ")"}" class="image">
                                            <img src="${doc.data().profilecover}">
                                        </a>
                                        <div class="novel_cont">
                                            <h3>
                                                <a href="https://novelpedia.co.kr/a/${doc.data().name + "(" + doc.data().birthday + ")"}">${doc.data().name + "(" + doc.data().birthday + ")"}</a>
                                            </h3>
                                            <p class="info">
                                                <span class="score">
                                                    <span style=""></span>
                                                </span>
                                            </p>
                                            <p class="summary">
                                                <a href="https://novelpedia.co.kr/n/${doc.data().recent_novel+ "(" + doc.data().name + ")"}">${doc.data().recent_novel}</a>
                                            </p>
                                        </div>
                                    </li>`;

                            number++;
                            $('.novel_top_rank').append(temp);
                        }
                        // 출판사(사진, 출판사명 링크, 설립일)
                        if(collection_name == 'publisher_document'){ 
                            var temp = `
                                    <li>
                                        <div class="top_numb">            
                                            <span class="top_num">
                                                <em class="1">${number}</em>
                                            </span>
                                        </div>
                                        <a href="https://novelpedia.co.kr/p/${doc.data().name}" class="image">
                                            <img src="${doc.data().profilecover}">
                                        </a>
                                        <div class="novel_cont">
                                            <h3>
                                                <a href="https://novelpedia.co.kr/p/${doc.data().name}">${doc.data().name}</a>
                                            </h3>
                                            <p class="info">
                                                <span class="score">
                                                    <span style=""></span>
                                                </span>
                                            </p>
                                            <p class="summary">${doc.data().establishdate}</p>
                                        </div>
                                    </li>`;
                            
                            number++;
                            $('.novel_top_rank').append(temp);
                        }

                        // 콘솔창에 데이터 정보 출력
                        console.log(doc.id, doc.data());
                    })
        
                }).catch((err) => {

                    console.log(err);
        
                });
            }
        };

        // 작가, 출판사 버튼 선택 -> 리뷰 수 버튼 비활성화
        function disable_Review() {
            document.getElementById("select6").disabled = true;
        }
        // 리뷰 수 버튼 활성화
        function enable_Review() {
            document.getElementById("select6").disabled = false;
        }
        // 리뷰 수 버튼 선택 -> 작가, 출판사 버튼 비활성화
        function disable_AuthorPublisher() {
            if (document.getElementById("select1").checked) {
                document.getElementById("select2").disabled = true;
                document.getElementById("select3").disabled = true;
            }
        }
        // 작가, 출판사 버튼 활성화
        function enable_AuthorPublisher() {
            if (document.getElementById("select1").checked) {
                document.getElementById("select2").disabled = false;
                document.getElementById("select3").disabled = false;
            }
        }

    </script>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="footer-col">
                    <ul>
                        <li><a href="#">공지사항</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">Q&A</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">의견보내기</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!--파이어베이스 연동 자바스크립트 파일-->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <!--제이쿼리-->
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    
    <!--파이어베이스 정보 가져오기--><!--파이어베이스 연동 키값-->
    <script src="./js/information.js"></script>

    <!--로그인 상태 체크-->
    <script src="./js/login_check.js"></script>
    <!--로그아웃을 위한 소스코드-->
    <script src="./js/logout.js"></script>
    <!--로그아웃 상태일 때-->
    <script src="./js/logout_state.js"></script>
</body>

</html>