<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
    <link href="css/password_check.css" rel="stylesheet">
    <link href="css/header.css" rel="stylesheet">
    <link href="css/footer.css" rel="stylesheet">
    <link href="css/user_modify.css" rel="stylesheet">
    <link href="css/mypage_menubar.css" rel="stylesheet">
    <link href="css/pwc_userm.css" rel="stylesheet">
    <title>마이페이지</title>
</head>

<body class="login_body">
    <header class="header">
        <a class="logo_a" href="http://novelpedia.co.kr">
            <!--<img class="logo" src="./image/novelpedia.png" height="40px">-->
            <img class="logo_icon" src="image/logo.png">
        </a>
        <div class="first_line">
            <div class="inner_item">
                <a id="open_close" href="#" class="navbar_toggleBtn">
                    <img id="close" src="image/메뉴_검정_버튼.png">
                </a>
                <div class="inner_inner_item">
                    <div class="search">
                        <div class="icon"></div>
                        <form method="get" action="search">
                            <div class="input">
                                <input type="text" placeholder="Search" id="mysearch" name="q">
                            </div>
                            <span class="clear" onclick="document.getElementById('mysearch').value = ''"></span>
                            <input type="submit" value="" class="search_btn">
                        </form>
                    </div>
                </div>
            </div>
            <div class="set">
                <div class="set_mid">
                    <ul class="bar_menu">
                        <li><a href="listpage.html">목록페이지</a></li>
                        <li class="mypage_header" id="mypage_button"><a href="mypage">마이페이지</a></li>
                        <li><a href="login.html" id="login_logout">Login</a></li>
                    </ul>
                </div>
            </div>
        </div>

    </header>

    <script>
        /*메뉴버튼 바꾸기 위한 변수*/
        const change_img = document.createElement('img');
        change_img.setAttribute('src', './image/메뉴_닫힘.png');
        change_img.setAttribute('id', 'close');

        const change_img_normal = document.createElement('img');
        change_img_normal.setAttribute('src', './image/메뉴_검정_버튼.png');
        change_img_normal.setAttribute('id', 'close');

        /*검색버튼에 대한 동작 변수*/
        const icon = document.querySelector('.search .icon');
        const search = document.querySelector('.search');
        const inner_item = document.querySelector('.inner_item');
        const inner_inner_item = document.querySelector('.inner_inner_item');
        const menu_window2 = document.querySelector('.header .set active');

        /*메뉴 버튼에 따른 동작 변수*/
        const toggleBtn = document.querySelector('.navbar_toggleBtn');
        const menu = document.querySelector('.bar_menu');
        const menu_window = document.querySelector('.header .set');

        /*메뉴버튼*/
        toggleBtn.onclick = function() {
            menu.classList.toggle('active');
            menu_window.classList.toggle('active');
            const lastDiv = document.getElementById('close');
            /*메뉴창 열림 여부에 따라 버튼 이미지 교체*/
            if (document.querySelector('.header .set').classList.contains('active')) {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img);
            } else {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img_normal);
            }

        }

        /*검색버튼*/
        icon.onclick = function() {
            icon.classList.toggle('active');
            search.classList.toggle('active');
            inner_item.classList.toggle('active');
            inner_inner_item.classList.toggle('active');
            menu_window.classList.toggle('search_active');
        }
    </script>

<!-- 비밀번호 재확인 -->
    <section class="check_section">
        <div class="checkbox">
            <h2>비밀번호 재확인</h2>
                <fieldset class="check_area">
                    <!--<legend> 로그인 구역</legend>-->   
                    <div>
                        <label for="loginpw">비밀번호</label>
                        <input type="password" id="loginpw" placeholder="비밀번호를 입력해주세요.">
                    </div>
                    <button id="check_btn">확인</button>
                </fieldset>
            
        </div>
    </section>

<!-- 사이드 바 -->
<input type="checkbox" id="menuicon">
<label for="menuicon" id=hamburger style="display: none;">
    <span></span>
    <span></span>
    <span></span>
</label>

    <nav class="mypage_sidebar" style="display: none";>
        <div class="mypage_menubar_content">
            <div class="mypage_title"><a href="user_modify.html">마이페이지</a>
            </div>

            <div class="mypage_imformation"><a href="user_modify.html">회원정보</a>
            </div>

            <div class="mypage_library">
                <input type="checkbox" id="answer01">
                <label for="answer01">
                    <div class="mypage_mtitle">내 서재</div>
                </label>

                <div class="mypage_list">
                    <div class="mypage_set1">
                        <div class="mypage_picture"><a href="view_record.html">작품</a></div>
                    </div>

                    <div class="mypage_set1">
                        <div class="mypage_author"><a href="a_record.html">작가</a></div>
                    </div>

                    <div class="mypage_set1">
                        <div class="mypage_publisher"><a href="p_record.html">출판사</a></div>
                    </div>

                    <div class="mypage_under_bar_boxing">
                        <div class="mypage_under_bar"></div>
                    </div>

                    <div class="mypage_set1">
                        <div class="mypage_visit"><a href="view_record.html">열람기록</a></div>
                    </div>
                </div>
            </div>

            <div class="mypage_review"><a href="#">리뷰</a></div>
        </div>
        <div class="mypage_leave">
            <div class="mypage_delete"><a href="#" id="delete-account" >회원탈퇴</a></div>
        </div>
    </nav>
    
    <section id="modify_user">
        
    </section>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="footer-col">
                    <ul>
                        <li><a href="#">공지사항</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">Q&A</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">의견보내기</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    
    
    <!--파이어베이스 연동 자바스크립트 파일-->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <!--제이쿼리-->
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    
    <!--파이어베이스 정보 가져오기--><!--파이어베이스 연동 키값-->
    <script src="./js/information.js"></script>

    <!--로그인 상태 체크-->
    <script src="./js/login_check.js"></script>
    <!--로그아웃을 위한 소스코드-->
    <script src="./js/logout.js"></script>
    <!--로그아웃 상태일 때-->
    <script src="./js/logout_state.js"></script>

    <script>
        firebaseEmailAuth.onAuthStateChanged(async function (user) {
            const docRef = db.collection("user").doc(user.email.split('@')[0] + user.uid);

            const doc = await docRef.get();
        
            if (doc.exists) {
                const loginId = localStorage.getItem('loginId');
                if (loginId) {
                    $('#signupid').val(loginId).prop('disabled', true);
                } 
                else {
                    console.log("로그인한 아이디가 존재하지 않습니다.");
                }
                const loginNickname = doc.data().닉네임;
                $('#signupnickname').val(loginNickname);
            }
            else {
                console.log("회원정보가 없습니다.");
            }

            const login_btn = document.querySelector('#check_btn');
            
            login_btn.addEventListener('click', async () => {
                const loginpw = document.querySelector('#loginpw').value;
                var userEmail = user.email;
                const savedPassword = localStorage.getItem('password');

                // 로그인 시도
                await firebaseEmailAuth.signInWithEmailAndPassword(user.email, loginpw);
                console.log(`회원정보는 ${user.email.split('@')[0] + user.uid}`);

                // 사용자 정보 조회
                const userInfoDoc = await db.collection('user').doc(user.email.split('@')[0] + user.uid).get();
                const userInfo = userInfoDoc.data();
                console.log(userInfo);

                if (loginpw === savedPassword) {
                    console.log("비밀번호가 일치합니다.");

                    $('.check_section').remove();
                    // 회원정보 수정 폼 출력
                    var form = `
                    <div class="user_modify">
                        <div class="space">
                            <div class="mypage">회원정보</div>
                        </div>
                        <div class="space2">
                            <div class="modify">회원정보 수정</div>
                        </div>
                        <form action="">
                            <div class="mid">
                                <div class="first">
                                    <div class="id">
                                        <label for="idtitle">아이디</label>
                                        <input type="text" id="signupid" placeholder="">
                                    </div>
                                    <div class="password">
                                        <label for="patitle">비밀번호</label>
                                        <input type="password" id="signupPass" placeholder=""> <!-- (수정) 비밀번호 수정 시 보이게-->
                                    </div>
                                    <div class="password2">
                                        <label for="pa2title">비밀번호 확인</label>
                                        <input type="password" id="passwordCheck" placeholder="">
                                    </div>
                                </div>
                                <div class="second">
                                    <div class="name">
                                        <label for="natitle">이름</label>
                                        <input type="text" id="signupname" placeholder="">
                                    </div>
                                    <div class="nickname">
                                        <label for="nititle">닉네임</label>
                                        <input type="text" id="signupnickname" placeholder="">
                                    </div>
                                    <div class="gender">
                                        <input type="radio" id="male" name="gender" value="male" disabled checked>
                                        <label for="male" id="male-label">남성</label>
                                        <input type="radio" id="female" name="gender" value="female" disabled>
                                        <label for="female" id="female-label">여성</label>
                                    </div>
                                    <div class="birthday">
                                        <label>생년월일</label>
                                        <input type="date" id="userBirthday" value="2001-10-05" disabled />
                                    </div>
                                    <div class="email">
                                        <label for="etitle">이메일</label>
                                        <div class="setting">
                                            <input type="text" name="email1" id="email1" placeholder="이메일 입력" size="15">
                                            <select id="email2">
                                                <option>직접 입력</option>
                                                <option>@gmail.com</option>
                                                <option>@naver.com</option>
                                                <option>@daum.com</option>
                                                <option>@yahoo.com</option>
                                                <option>@nate.com</option>
                                                <option>@novelpedia.com</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="block">
                                        <button class="check" type="button">인증하기</button>
                                    </div>
                                </div>

                                <div class="third">
                                    <div class="phone">
                                        <label for="ptitle">전화번호</label>
                                        <input type="text" id ="signupphonNumber" placeholder="">
                                    </div>
                                    <div class="block2">
                                        <button class="check2" type="button">인증하기</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div class="buttons">
                            <button id = "cancelButton" type="submit">취소</button>
                            <button id = "saveButton" type="button">저장</button>
                        </div>
                    </div>`;

                    // 폼 생성
                    $('#modify_user').append(form);
                    

                    // 데이터 출력
                    const loginId = localStorage.getItem('loginId');

                    if (loginId) {
                        $('#signupid').val(loginId).prop('disabled', true);
                    } 
                    else {
                        console.log("로그인한 아이디가 존재하지 않습니다.");
                    }

                    const loginName = doc.data().이름;
                    $('#signupname').val(doc.data().이름).prop('disabled', true);

                    const loginNickname = doc.data().닉네임;
                    $('#signupnickname').val(loginNickname);

                    const loginGender = doc.data().성별;

                    if (loginGender === '남성') {
                        $('label[id="male-label"]').css('color', 'white');
                        $('label[id="male-label"]').css('background-color', '#769fcd');
                        $('label[id="female-label"]').css('color', 'black');
                        $('label[id="female-label"]').css('background-color', '#e5e5e5');
                    }

                    if (loginGender === '여성') {
                        $('label[id="male-label"]').css('color', 'black');
                        $('label[id="male-label"]').css('background-color', '#e5e5e5');
                        $('label[id="female-label"]').css('color', 'white');
                        $('label[id="female-label"]').css('background-color', '#769fcd');
                    }

                    const userBirthday = doc.data().생년월일;
                    document.getElementById("userBirthday").value = userBirthday;

                    const loginEmail = doc.data().이메일;

                    const atIndex = loginEmail.indexOf('@');
                    const loginEmail1 = loginEmail.substring(0, atIndex);
                    const loginEmail2 = loginEmail.substring(atIndex + 1);

                    $('#email1').val(loginEmail1);
                    $('#email2 option').filter(function() {
                        return $(this).text() === "@" + loginEmail2;
                    }).prop('selected', true); 

                    const loginPhonnum = doc.data().전화번호;
                    $('#signupphonNumber').val(loginPhonnum);
                    $('#hamburger').show();
                    $('.mypage_sidebar').show();

                } 
                else {
                    // loginpw와 savedPassword가 다를 때 실행되는 코드
                    console.log("비밀번호가 일치하지 않습니다.");
                }

                $('#saveButton').click(function() { // 저장 버튼 클릭 이벤트
                    console.log("클릭");
                    const newName = $('#signupname').val(); // 수정된 이름 값
                    const newNickname = $('#signupnickname').val(); // 수정된 닉네임 값
                    const newGender = $('input[name="gender"]:checked').val(); // 수정된 성별 값
                    const newBirthday = $('#userBirthday').val(); // 수정된 생년월일 값
                    const newEmail1 = $('#email1').val(); // 수정된 이메일 @ 앞부분 값
                    const newEmail2 = $('#email2').val(); // 수정된 이메일 @ 뒷부분 값
                    const newEmail = newEmail1 + newEmail2; // 수정된 전체 이메일 값
                    const newPhonenum = $('#signupphonNumber').val(); // 수정된 전화번호 값
                    const newPassword = $('#signupPass').val(); //(수정)수정된 비밀번호 값
                    const CheckPassword = $('#passwordCheck').val(); //(수정)수정된 비밀번호 재확인 값

                    if (newPassword === CheckPassword) { //(수정)변경할 비밀번호 값과 비밀번호 재확인 값이 일치할 시
                        user.updatePassword(newPassword).then(function() {
                            console.log('비밀번호가 변경되었습니다.');
                        }); //(수정)변경 and 수정완료 출력
                            
                        const docRef = db.collection("user").doc(user.email.split('@')[0] + user.uid);
                        docRef.update({ // Firestore 데이터 업데이트
                            이름: newName,
                            닉네임: newNickname,
                            성별: newGender,
                            생년월일: newBirthday,
                            이메일: newEmail,
                            전화번호: newPhonenum, 
                        }).then(() => {
                            alert("수정 되었습니다.");
                            // 저장 성공 메시지 출력 및 이후 처리
                        }).catch((error) => {
                            alert(error);
                            // 저장 실패 메시지 출력
                        });
                    } else {
                        alert('비밀번호가 일치하지 않습니다.');
                    }
                });
                    
                $('#cancelButton').click(function() {
                    window.location.href = 'index.html';
                });
            });
        });   
</script> 

<script>
    //회원 탈퇴 기능
    const deleteBtn = document.querySelector('#delete-account'); //탈퇴 버튼 기능

    deleteBtn.addEventListener('click', (event) => { //버튼 클릭 시 발생
        event.preventDefault(); //잠깐 작동 정지하고

        if (confirm('노벨피디아를 탈퇴하시겠습니까?')) {
            docRef.delete().then(function() { 
                confirm("탈퇴 되었습니다.");
                location.href = "login.html"; //로그인 화면으로 이동
            }).catch(function(error) {
                console.error("탈퇴 실패되었습니다.", error);
            }); 
        }
    });
</script>
</body>
</html>