<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
    <link href="../css/novel_page.css" rel="stylesheet">
    <link href="../css/header.css" rel="stylesheet">
    <link href="../css/footer.css" rel="stylesheet">
    <link href="../css/getOther.css" rel="stylesheet">
    <title>작품페이지</title>
</head>

<body>
    <header class="header">
        <a class="logo_a" href="../index.html">
            <!--<img class="logo" src="./image/novelpedia.png" height="40px">-->
            <img class="logo_icon" src="../image/logo.png">
        </a>
        <div class="first_line">
            <div class="inner_item">
                <a id="open_close" href="#" class="navbar_toggleBtn">
                    <img id="close" src="../image/메뉴_검정_버튼.png">
                </a>
                <div class="inner_inner_item">
                    <div class="search">
                        <div class="icon"></div>
                        <form method="get" action="../search">
                            <div class="input">
                                <input type="text" placeholder="Search" id="mysearch" name="q">
                            </div>
                            <span class="clear" onclick="document.getElementById('mysearch').value = ''"></span>
                            <input type="submit" value="" class="search_btn">
                        </form>
                    </div>
                </div>
            </div>
            <div class="set">
                <div class="set_mid">
                    <ul class="bar_menu">
                        <input type="checkbox" id="list_open">
                        <label for="list_open" class="list_page_label">
                            <li class="list_li">목록페이지</li>
                            <div class="header_list">
                                <div class="header_set1">
                                    <div class="header_picture"><a href="../list/novel">작품</a></div>
                                </div>
                                <div class="header_set1">
                                    <div class="header_author"><a href="../list/author">작가</a></div>
                                </div>
            
                                <div class="header_set1">
                                    <div class="header_publisher"><a href="../list/publisher">출판사</a></div>
                                </div>
                            </div>
                        </label>
                        <li class="mypage_header" id="mypage_button"><a href="../mypage">마이페이지</a></li>
                        <li><a href="../login" id="login_logout">Login</a></li>
                    </ul>
                </div>
            </div>
        </div>

    </header>

    <script>
        /*메뉴버튼 바꾸기 위한 변수*/
        const change_img = document.createElement('img');
        change_img.setAttribute('src', '../image/메뉴_닫힘.png');
        change_img.setAttribute('id', 'close');

        const change_img_normal = document.createElement('img');
        change_img_normal.setAttribute('src', '../image/메뉴_검정_버튼.png');
        change_img_normal.setAttribute('id', 'close');

        /*검색버튼에 대한 동작 변수*/
        const icon = document.querySelector('.search .icon');
        const search = document.querySelector('.search');
        const inner_item = document.querySelector('.inner_item');
        const inner_inner_item = document.querySelector('.inner_inner_item');
        const menu_window2 = document.querySelector('.header .set active');

        /*메뉴 버튼에 따른 동작 변수*/
        const toggleBtn = document.querySelector('.navbar_toggleBtn');
        const menu = document.querySelector('.bar_menu');
        const menu_window = document.querySelector('.header .set');

        /*메뉴버튼*/
        toggleBtn.onclick = function() {
            menu.classList.toggle('active');
            menu_window.classList.toggle('active');
            const lastDiv = document.getElementById('close');
            /*메뉴창 열림 여부에 따라 버튼 이미지 교체*/
            if (document.querySelector('.header .set').classList.contains('active')) {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img);
            } else {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img_normal);
            }

        }

        /*검색버튼*/
        icon.onclick = function() {
            icon.classList.toggle('active');
            search.classList.toggle('active');
            inner_item.classList.toggle('active');
            inner_inner_item.classList.toggle('active');
            menu_window.classList.toggle('search_active');
        }
    </script>

    <section class="section_empty" id="section_empty">
        <div id="empty"></div>
    </section>

    <section class="document_section" id="document_section">
        <div class="document_section_all">
            <!--작품 제목(작가명)-->
            <div class="document_name">
                <a href="#" id="document_name">작품제목(작가명)</a>
            </div>

            <div class="document_bundle_button">
                <a class="edit" href="../e" id="go_edit">편집</a>
                <a class="history" href="../h" id="go_history">역사</a>
                <a class="delete" id="go_delete">삭제</a>
            </div>

            <div class="document_view_update">
                <div class="view_block">
                    <span id="view_name">조회수 :</span>
                    <span id="view_get"></span>
                </div>
                <span class="sl">/</span>
                <div class="update_block">
                    <span id="update_name">최종 수정 :</span>
                    <span id="update_get"></span>
                </div>
            </div>

            <div class="document_bundle">
                <div class="document_bundle_cover">
                    <!--작품표지-->
                    <div class="document_bookcover">
                        <img id="document_bookcover" src="../image/표지_미등록.png">
                        <!--관심등록 및 버튼-->
                        <div class="document_button">
                            <input type="checkbox" id="like_button" style="display: none;">
                            <label class="like" for="like_button" onclick="like()">좋아요</label>
                            <label class="heart" for="like_button" onclick="like()">♥</label>
                            <label class="like_count" id="like_count">0</label>
                        </div>
                    </div>
                </div>


                <!--목차-->
                <div class="document_index">
                    <ol>목차
                        <li><a href="#document_information">작품정보</a></li>
                        <li><a href="#document_summary">줄거리</a></li>
                        <li><a href="#document_review">리뷰</a></li>
                        <li><a></a></li>
                        <li><a></a></li>
                    </ol>
                </div>
            </div>

            <!--작품정보 : 표-->
            <div id="document_information" class="document_information">
                <table>
                    <tr>
                        <th colspan="2">작품정보</th>
                    </tr>
                    <!--Work Info-->
                    <tr>
                        <td class="title">제목</td>
                        <td class="content" id="document_information_title"></td>
                    </tr>

                    <tr>
                        <td class="title">작가</td>
                        <td class="content"><a href="../author.html" id="document_information_author"></a></td>
                    </tr>

                    <tr>
                        <td class="title">출판사</td>
                        <td class="content"><a href="../publisher.html" id="document_information_publisher"></a></td>
                    </tr>

                    <tr>
                        <td class="title">평점</td>
                        <td class="content" id="document_information_star"></td>
                    </tr>

                    <tr>
                        <td class="title">장르</td>
                        <td class="content" id="document_information_genre"></td>
                    </tr>

                    <tr>
                        <td class="title">구매처 및 연재처</td>
                        <td class="content"><a href="https://yes24.com" target="_blank" id="document_information_buy_series">Yes24</a></td>
                    </tr>

                    <tr>
                        <td class="title">출간일</td>
                        <td class="content" id="document_information_publish_date">2022-08-04</td>
                    </tr>
                </table>
            </div>

            <!-- 태그영역 -->
            <div class="document_tag_area" id="document_tag_area">

            </div>

            <!--줄거리-->
            <div id="document_summary" class="document_summary">
                <div class="title">
                    <p class="p_title">줄거리</p>
                </div>
                <input type="checkbox" class="read_more" id="more" />
                <!--<div class="lable_Square"></div>-->

                <div class="content" id="summary_content">
                    <p id="document_summary_content">
                    </p>
                </div>
                <label for="more" class="trigger" id="more_button"></label>
            </div>

            <!-- 추천 알고리즘 영역 -->
            <!--작품 목록-->
            <div id="document_recommand" class="document_recommand">
                <div class="title">
                    <p class="p_title">작품추천</p>
                </div>
                <div class="content">
                    <div class="document_first" id="recommand_document">
                        <!-- <div class="document_list">
                            <a href="#">
                                <img src="./image/표지_미등록.png">
                                <p>소설제목</p>
                            </a>
                        </div> -->
                    </div>
                </div>
            </div>

            <!--리뷰-->
            <!--<h1>리뷰</h1>-->
            <div id="document_review" class="document_review">
                <div class="title">
                    <p class="p_title">리뷰</p>
                </div>
                <div class="content" id="review_content_div">
                    <div class="box_estimate" id="review_input">
                        <div class="document_500char">
                            <span class="document_500char_name">300자평</span>
                        </div>
                        <form>
                            <div class="content_input">
                                <div class="star_box">
                                    <div class="star">
                                        <input type="radio" name="rating" value="5" id="rate1"><label for="rate1">★</label>
                                        <input type="radio" name="rating" value="4" id="rate2"><label for="rate2">★</label>
                                        <input type="radio" name="rating" value="3" id="rate3"><label for="rate3">★</label>
                                        <input type="radio" name="rating" value="2" id="rate4"><label for="rate4">★</label>
                                        <input type="radio" name="rating" value="1" id="rate5"><label for="rate5">★</label>
                                    </div>
                                </div>
                                <div class="content_boxing">
                                    <textarea id="char_content" onkeydown="calc()" onkeyup="calc()" onkeypress="calc()" maxlength="300"></textarea>
                                    <div class="register_button">
                                        <input class="register_submit" type="button" value="등록" id="review_send" onclick="review()">
                                    </div>
                                </div>
                                <div class="char_number">
                                    <input type="number" id="char_result" value="0" readonly>
                                    <span class="max_number">/ 300</span>
                                </div>
                            </div>
                        </form>

                        <!-- <div class="review_button">
                            <a href="#" class="review_write">리뷰작성</a>
                        </div> -->
                    </div>

                    <script>
                        function calc() {
                            document.getElementById('char_result').value = document.getElementById('char_content').value.length;
                        }
                    </script>
                    <div class="line" id="review_line"></div>
                    <div id="review_add"></div>
                </div>
                <div class="previous_next" id="next_back_package">
                    <button class="previous" id="back">&#9664; 이전</button>
                    <button class="next" id="next">다음 &#9654;</button>
                </div>
            </div>

            <!--구분선-->
            <!--안내-->
            <div class="alram">
                <p>※여기부터는 사용자가 추가한 내용입니다※</p>
            </div>

            <!--기타-->
            <div class="document_other" id="document_other">
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="footer-col">
                    <ul>
                        <li><a href="/notice">공지사항</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">신고 및 건의</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">의견보내기</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>


    

    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="../js/information.js"></script>

    <!--로그인 상태 체크-->
    <script src="../js/login_check.js"></script>
    <!--로그아웃을 위한 소스코드-->
    <script src="../js/logout.js"></script>
    <!--로그아웃 상태일 때-->
    <script src="../js/logout_state.js"></script>

    <!-- 주소창에서 url 정보 받아오기 -->
    <script>
        const path_url = window.location.pathname;
        const path_decode = decodeURI(path_url);
        let document_name = path_decode.split('/');

        // 타이틀 변경
        document.title = document_name[2];

        // 편집, 역사 페이지 버튼 주소 초기화
        document.getElementById("go_edit").href = "../e/" + document_name[2];
        document.getElementById("go_history").href = "../h/" + document_name[2];
    </script>

    <!-- 문서 열면서 동기적으로 실행할 함수 -->
    <script>
        async function start_novel(){
            await getUser();
            await getInformation();
            await getReviewInfor();
            console.log(login_user_information);
        }

        start_novel();
    </script>

    <!-- 추천 알고리즘 불러오기 -->
    <script>
        fetch('https://64zqrruv262ef2ombx64kkts7i0zcipv.lambda-url.ap-southeast-2.on.aws/',{
            method: 'POST', // 요청 메서드를 POST로 설정
            body: JSON.stringify({ document_name : document_name[2]}) // 매개변수를 JSON 형식으로 문자열화하여 페이로드에 포함
        }).then(response => response.json())
            .then(data => {
                console.log(data)
                if(data==null){
                    var temp =
                    `
                        <div class="document_list_none">
                            작품을 추천하기에 정보가 부족하거나, 문서가 생성된지 시간이 얼마 지나지 않았습니다. NULL
                        </div>
                    `
                    $('#recommand_document').append(temp);
                }
                else{
                    if(data.length == 1){
                        var temp =
                        `
                            <div class="document_list_none">
                                작품을 추천하기에 정보가 부족하거나, 문서가 생성된지 시간이 얼마 지나지 않았습니다.
                            </div>
                        `
                        $('#recommand_document').append(temp);
                    }
                    else{
                        data.forEach((doc)=>{
                            console.log(doc);
                            if(doc==document_name[2]){
                                
                            }
                            else{
                                db.collection('novel_document').doc(doc).get().then((result) => {
                                    var temp =
                                    `
                                        <div class="document_list">
                                            <a href="/n/${doc}">
                                                <img src="${result.data().bookcover}">
                                                <p>${result.data().name}</p>
                                            </a>
                                        </div>
                                    `
                                    $('#recommand_document').append(temp);
                                }).catch((err) => {

                                })
                            }
                        })
                    }
                }                
            }).catch(error => console.error(error));
    </script>
    
    <!-- 리뷰 -->
    <script>
        var user_star_rating = 0;
        async function getReviewInfor() {
            const getDocRef = db.collection('review').doc(document_name[2]).collection('short').doc(login_user_information);
            try{
                const doc = await getDocRef.get();
                if (doc.exists) {
                    // 이미 리뷰목록에 있는 경우
                    user_star_rating = doc.data().star;
                    console.log("review exists true");
                    document.getElementById('review_input').remove();
                    document.getElementById('review_line').remove();
                    
                } else {
                    // 리뷰 목록에 없는 경우
                    console.log("review exists false");
                }
            }
            catch(error){
                console.log('Error getting document:', error);
            }
        }

        // 리뷰작성
        function review(){
            let review_path = db.collection('review').doc(document_name[2]).collection('short').doc(login_user_information);
            var star_rating = 0;

            document.getElementsByName('rating').forEach((node) => {
                if(node.checked)  {
                    star_rating  = node.value;
                }
            });
            if(login_check == true){
                if(star_rating===0){
                    alert("평점을 입력하세요");
                }
                else if($('#char_content').val().length<1){
                    alert("아무 내용도 입력되지 않았습니다");
                }
                else{
                    console.log(star_rating);
                    var n_name = document_name[2].split('(');
                    var n_author = n_name[1].split(')');

                    var review_data = {
                        id : user_id,
                        nick: nickname,
                        name: n_name[0],
                        author: n_author[0],
                        content: $('#char_content').val(),
                        star: star_rating,
                        date: new Date()
                    };
                    review_path.set(review_data).then(async (result) => {
                        await reviewIncCounter(star_rating);
                        await history_reviewIncCounter(star_rating);
                        await review_add_user(star_rating);
                        location.reload();
                    }).catch((error) => {
                        console.log(error);
                        alert("review failed.");
                    });
                }
            }
            else{
                alert("로그인 후 이용해주세요");
            }
        }

        function review_delete(){
            let review_path = db.collection('review').doc(document_name[2]).collection('short').doc(login_user_information);

            console.log(user_star_rating);

            review_path.delete().then(async (result) => {
                await reviewDimCounter(user_star_rating);
                await history_reviewDimCounter(user_star_rating);
                await review_delete_user();
                location.reload();
            }).catch((error) => {
                console.log(error);
                alert("delete failed.");
            });
        }

        var next_2;
        var before;
        var next = db.collection("review").doc(document_name[2]).collection("short").orderBy("date", "desc").limit(5);


        // 리뷰가져오기
        db.collection("review").doc(document_name[2]).collection("short").orderBy("date", "desc").limit(5).get().then((결과) => {
            var review_count = 0;
            var temp = `<div class="review_pre"><div class="review_pre_set"><p>※리뷰가 존재하지 않습니다.※</p></div></div>`;

            
            결과.forEach((result) => {
                review_count = review_count + 1;
                if(review_count>0){
                    if(result.data().id == user_id){
                        temp = 
                        `<div class="review_pre">
                            <div class="review_pre_set">
                                <p>${result.data().nick + "(" + result.data().id + ")"}</p>
                                <p>|</p>
                                <p>${result.data().star + ".0"}</p>
                                <div class="balloon">
                                    <p class="review_content">${result.data().content}</p>
                                </div>
                                <div id="review_delete" onclick="review_delete()"><p>삭제</p></div>
                            </div>
                        </div>`;
                    }
                    else{
                        temp = 
                        `<div class="review_pre">
                            <div class="review_pre_set">
                                <p>${result.data().nick + "(" + result.data().id + ")"}</p>
                                <p>|</p>
                                <p>${result.data().star + ".0"}</p>
                                <div class="balloon">
                                    <p>${result.data().content}</p>
                                </div>
                            </div>
                        </div>`;
                    }
                }

                $('#review_add').append(temp);

                var lastVisible = 결과.docs[결과.docs.length-1];
                if(결과.docs.length>4){
                }
                else{
                    document.getElementById('next').style.display = "none";
                }

                before = next;
                next = db.collection("review").doc(document_name[2]).collection("short").orderBy("date", "desc").startAfter(lastVisible).limit(5);
                next_2 = db.collection("review").doc(document_name[2]).collection("short").orderBy("date", "desc").startAfter(lastVisible).limit(1);
                next_back();
            });

            if(review_count==0){
                $('#review_add').append(temp);
                $('#next_back_package').remove();
            }
        }).catch((err) => {
                console.log(err);
        })

        

        document.getElementById('next').addEventListener("click", function() {
            $('#review_add').remove();
            var list_append = `<div id="review_add"></div>`
            $('#review_content_div').append(list_append);

            var temp;

            next.get().then((결과) => {
                결과.forEach((result)=>{
                    console.log(result.data())

                    if(result.data().id == user_id){
                        temp = 
                        `<div class="review_pre">
                            <div class="review_pre_set">
                                <p>${result.data().nick + "(" + result.data().id + ")"}</p>
                                <p>|</p>
                                <p>${result.data().star + ".0"}</p>
                                <div class="balloon">
                                    <p class="review_content">${result.data().content}</p>
                                </div>
                                <div id="review_delete" onclick="review_delete()"><p>삭제</p></div>
                            </div>
                        </div>`;
                    }
                    else{
                        temp = 
                        `<div class="review_pre">
                            <div class="review_pre_set">
                                <p>${result.data().nick + "(" + result.data().id + ")"}</p>
                                <p>|</p>
                                <p>${result.data().star + ".0"}</p>
                                <div class="balloon">
                                    <p>${result.data().content}</p>
                                </div>
                            </div>
                        </div>`;
                    }

                    $('#review_add').append(temp);
                })
                var b_lastVisible;
                if (결과.docs.length>4){
                    b_lastVisible = 결과.docs[결과.docs.length - 5];
                }
                else{
                    b_lastVisible = 결과.docs[결과.docs.length - 결과.docs.length];
                }

                before = db.collection("review").doc(document_name[2]).collection("short").orderBy("date", "asc").startAfter(b_lastVisible).limit(5);
                var lastVisible = 결과.docs[결과.docs.length-1];
                next = db.collection("review").doc(document_name[2]).collection("short").orderBy("date", "desc").startAfter(lastVisible).limit(5);
                next_2 = db.collection("review").doc(document_name[2]).collection("short").orderBy("date", "desc").startAfter(lastVisible).limit(1);
                next_back_check = next_back_check + 1;
                next_back();
            }).catch((err) => {
                console.log(err);
            });
        });

        document.getElementById('back').addEventListener("click", function() {
            $('#review_add').remove();
            var list_append = `<div id="review_add"></div>`
            $('#review_content_div').append(list_append);

            var temp;
        
            before.get().then((결과) => {
                for(var i = 4; i>-1; i--){
                    if(결과.docs[i].data().id == user_id){
                        temp = 
                        `<div class="review_pre">
                            <div class="review_pre_set">
                                <p>${결과.docs[i].data().nick + "(" + 결과.docs[i].data().id + ")"}</p>
                                <p>|</p>
                                <p>${결과.docs[i].data().star + ".0"}</p>
                                <div class="balloon">
                                    <p class="review_content">${결과.docs[i].data().content}</p>
                                </div>
                                <div id="review_delete" onclick="review_delete()"><p>삭제</p></div>
                            </div>
                        </div>`;
                    }
                    else{
                        temp = 
                        `<div class="review_pre">
                            <div class="review_pre_set">
                                <p>${결과.docs[i].data().nick + "(" + 결과.docs[i].data().id + ")"}</p>
                                <p>|</p>
                                <p>${결과.docs[i].data().star + ".0"}</p>
                                <div class="balloon">
                                    <p>${결과.docs[i].data().content}</p>
                                </div>
                            </div>
                        </div>`;
                    }

                    $('#review_add').append(temp);
                }

                // 결과.forEach((doc)=>{
                    
                // })
                var b_lastVisible = 결과.docs[결과.docs.length-1];
                before = db.collection("review").doc(document_name[2]).collection("short").orderBy("date", "asc").startAfter(b_lastVisible).limit(5);

                var lastVisible;
                if (결과.docs.length>4){
                    lastVisible = 결과.docs[결과.docs.length - 5];
                }
                else{
                    lastVisible = 결과.docs[결과.docs.length - 결과.docs.length];
                }

                next = db.collection("review").doc(document_name[2]).collection("short").orderBy("date", "desc").startAfter(lastVisible).limit(5);
                next_2 = db.collection("review").doc(document_name[2]).collection("short").orderBy("date", "desc").startAfter(lastVisible).limit(1);
                next_back_check = next_back_check - 1;
                next_back();
            }).catch((err) => {
                console.log(err);
            });
        });


        let next_back_check = 1;

        function next_back(){
            if(next_back_check == 1){
                document.getElementById('back').style.display = "none";

                next_2.get().then((결과) => {
                    console.log("결과" + 결과.docs.length);

                    if(결과.docs.length>0){
                        document.getElementById('next').style.display = "block";
                    }
                    else{
                        document.getElementById('next').style.display = "none";
                    }   
                    
                }).catch((err) => {
                    console.log(err);
                });
            }
            else{
                document.getElementById('back').style.display = "flex";

                next_2.get().then((결과) => {
                    console.log("결과" + 결과.docs.length);

                    if(결과.docs.length>0){
                        document.getElementById('next').style.display = "flex";
                    }
                    else{
                        document.getElementById('next').style.display = "none";
                    }   
                    
                }).catch((err) => {
                    console.log(err);
                    
                });
            }
        }



        // 리뷰 추가시 작품문서 평점 초기화
        async function reviewIncCounter(star_t){
            const docRef = db.collection('novel_document').doc(document_name[2]);
            return await docRef.update({
                star: firebase.firestore.FieldValue.increment(star_t),
                star_count: firebase.firestore.FieldValue.increment(1)
            }).then(() => {
                console.log("좋아요 증가 성공");
                // history(document_bookcover);
                // console.log("Document successfully updated!");
            }).catch((error) => {
                console.log(error);
            });
        }

        // 리뷰 삭제시 작품문서 평점 초기화
        async function reviewDimCounter(star_t){
            const docRef = db.collection('novel_document').doc(document_name[2]);
            return await docRef.update({
                star: firebase.firestore.FieldValue.increment(-star_t),
                star_count: firebase.firestore.FieldValue.increment(-1)
            }).then(() => {
                console.log("좋아요 제거 성공");
            }).catch((error) => {
                console.log(error);
            });
        }

        // 리뷰 추가시 작품문서 평점 초기화
        async function history_reviewIncCounter(star_t){
            const docRef = db.collection('history').doc(document_name[2]).collection('data').doc('count');
            return await docRef.update({
                star: firebase.firestore.FieldValue.increment(star_t),
                star_count: firebase.firestore.FieldValue.increment(1)
            }).then(() => {
                console.log("역사 좋아요 증가 성공");
            }).catch((error) => {
                console.log(error);
            });
        }

        // 리뷰 삭제시 작품문서 평점 초기화
        async function history_reviewDimCounter(star_t){
            const docRef = db.collection('history').doc(document_name[2]).collection('data').doc('count');
            return await docRef.update({
                star: firebase.firestore.FieldValue.increment(-star_t),
                star_count: firebase.firestore.FieldValue.increment(-1)
            }).then(() => {
                console.log("역사 좋아요 제거 성공");
            }).catch((error) => {
                console.log(error);
            });
        }

        async function review_add_user(star_t){
            const docRef = db.collection('user').doc(login_user_information).collection('review').doc(document_name[2]);
            var name_information = document_name[2].split('(');
            var author_information = name_information[1].split(')');
            var info = {
                d_name: document_name[2],
                name:name_information[0],
                author: author_information[0],
                content: $('#char_content').val(),
                star: star_t,
                date: new Date()
            };
            await docRef.set(info).then((result) => {
                console.log("user에 저장완료");
            }).catch((error) => {
                alert("user save failed.", error);
            });

        }

        async function review_delete_user(){
            const docRef = db.collection('user').doc(login_user_information).collection('review').doc(document_name[2]);
            await docRef.delete().then(async (result) => {
                console.log("user 정보 삭제 완료");
            }).catch((error) => {
                console.log(error);
                alert("user delete failed.");
            });
        }
    </script>

    <script>
        var like_state = false;

        async function getInformation() {
            console.log("loging : " + login_user_information);
            const getDocRef = db.collection('user').doc(login_user_information).collection('like').doc(document_name[2]);
            try{
                const doc = await getDocRef.get();
                if (doc.exists) {
                    // 이미 좋아요 목록에 있는 경우
                    console.log("exists true");
                    document.getElementById('like_button').checked = true;
                    like_state = true;
                } else {
                    // 좋아요 목록에 없는 경우
                    console.log("exists false");
                    like_state = false;
                }
            }
            catch(error){
                console.log('Error getting document:', error);
            }
        }

        function like(){
            if(login_check == true){
                if(like_state == true) {
                    // 이미 좋아요 목록에 있는 경우
                    db.collection('user').doc(login_user_information).collection('like').doc(document_name[2]).delete().then(function() {
                        likeDimCounter();
                        history_likeDimCounter();
                        console.log("문서 삭제 완료");
                        like_state = false;
                    }).catch(function(error) {
                        console.error("Error removing document: ", error);
                    });
                } else {
                    // 좋아요 목록에 없는 경우
                    var name_information = document_name[2].split('(');
                    var author_information = name_information[1].split(')');
                    var info = {
                        name: name_information[0],
                        author: author_information[0],
                        date: new Date(),
                        classification: "n"
                    };
                    db.collection('user').doc(login_user_information).collection('like').doc(document_name[2]).set(info).then((result) => {
                        likeIncCounter();
                        history_likeIncCounter();
                        alert("추가 완료");
                        like_state = true;
                    }).catch((error) => {
                        alert("failed.", error);
                    });
                }
            }
            else{
                alert("로그인 후 이용해주세요");
                document.getElementById("like_button").checked = true;
            }
        }

        // 좋아요 추가 업데이트
        function likeIncCounter(){
            const docRef = db.collection('novel_document').doc(document_name[2]);
            return docRef.update({
                like: firebase.firestore.FieldValue.increment(1),
            }).then(() => {
                console.log("좋아요 증가 성공");
                document.getElementById("like_count").innerText = Number($("label[id='like_count']").text()) + 1;
            }).catch((error) => {
                console.log(error);
            });
        }

        // 좋아요 제거 업데이트
        function likeDimCounter(){
            const docRef = db.collection('novel_document').doc(document_name[2]);
            return docRef.update({
                like: firebase.firestore.FieldValue.increment(-1),
            }).then(() => {
                document.getElementById("like_count").innerText = Number($("label[id='like_count']").text()) - 1;
                console.log("좋아요 제거 성공");
            }).catch((error) => {
                console.log(error);
            });
        }


        // 역사 data 컬렉션 좋아요 증가 업데이트
        function history_likeIncCounter(){
            const docRef = db.collection('history').doc(document_name[2]).collection('data').doc('count');
            return docRef.update({
                like: firebase.firestore.FieldValue.increment(1),
            }).then(() => {
                console.log("역사 좋아요 증가 성공");
            }).catch((error) => {
                console.log(error);
            });
        }

        // 역사 data 컬렉션 좋아요 감소 업데이트
        function history_likeDimCounter(){
            const docRef = db.collection('history').doc(document_name[2]).collection('data').doc('count');
            return docRef.update({
                like: firebase.firestore.FieldValue.increment(-1),
            }).then(() => {
                console.log("역사 좋아요 제거 성공");
            }).catch((error) => {
                console.log(error);
            });
        }
    </script>

    <script>

        var ip_address_info;
        var cookie_name

        if(document_name[1]=="hn"){
            window.addEventListener("load", async function() { //새로고침 함수
                await data_loading();
                await getHistory();
                // await getCookie();
                // countSpan.textContent = view;
                            
            });
        }
        else{
            window.addEventListener("load", async function() { //새로고침 함수
                await data_loading();
                await getCookie();
                // countSpan.textContent = view;
                            
            });

            
        }

        $.getJSON("https://ipinfo.io", function(data) {
            ip_address_info = data.ip;
            //setCookie 함수를 콜백 안에서 호출 
        })

        function setCookie(name, day) {
            var date = new Date();
            date.setDate(date.getDate() + day); //하루 뒤 만료
                            
            var mycookie = '';
            mycookie += name //이름
            // mycookie += name + '=' + value + ';';
            mycookie += 'Expires=' + date.toUTCString(); //만료 + 문자형식변환
                            
            document.cookie = mycookie; //쿠키 설정, 생성

        }

        async function getCookie() {
            var cookies = document.cookie.split(';');
            console.log(cookies);

            var currentCookie = document.cookie;
            var cookieCheck = currentCookie.indexOf(document_name[2]);
            console.log(cookieCheck);

            if(cookieCheck > - 1){
                console.log("이미 조회한 게시물");
            }
            else {
                cookie_name = "NovelPedia" + document_name[2]
                await setCookie(cookie_name, 1);
                await viewIncCounter();
                await history_viewIncCounter();
                console.log("처음 조회하는 게시물");
            }
        }

        async function viewIncCounter(){
            const docRef = db.collection('novel_document').doc(document_name[2]);
            return await docRef.update({
                view: firebase.firestore.FieldValue.increment(1),
            }).then(() => {
                console.log("조회수 증가 성공");
                
                // history(document_bookcover);
                // console.log("Document successfully updated!");
            }).catch((error) => {
                console.log(error);
            });
        }

        // 역사 콜렉션에 조회수 데이터 저장
        async function history_viewIncCounter(){
            const docRef = db.collection('history').doc(document_name[2]).collection('data').doc('count');
            return await docRef.update({
                view: firebase.firestore.FieldValue.increment(1),
            }).then(() => {
                console.log("역사 조회수 증가 성공");
            }).catch((error) => {
                console.log(error);
            });
        }
     
    </script>

    <!-- History count 가져오기-->
    <script>
        async function getHistory(){
            var historyPath = db.collection("history").doc(document_name[2]).collection("data").doc("count");
            await historyPath.get().then((결과) => {
                document.getElementById("view_get").innerText = 결과.data().view + "회";
                document.getElementById("update_name").innerText = "수정 일시 : ";
                document.getElementById("like_count").innerText = 결과.data().like;
            }).catch((err)=>{
                console.log("역사_카운트_로드 실패");
            });
        }
    </script>

    <script>

        var docPath;
        var document_view;
        var star_cal;
        var document_like;
        let data_save_array = [];

        async function data_loading(){
            if(document_name[1]=="hn"){
                var path_url = window.location.search;
                var path_decode = decodeURI(path_url);
                var document_url_version = path_decode.split('v=');
                docPath = db.collection('history').doc(document_name[2]).collection('version').doc(document_url_version[1]);
                
                document.getElementById('go_delete').remove();
            }
            else{
                docPath = db.collection('novel_document').doc(document_name[2]);
            }
            
            document.getElementById('document_name').innerText = document_name[2];

            await docPath.get().then((결과) => {
                data_save_array = 결과;
                // 불러온 내용 바탕으로 내용 바꾸기
                console.log(결과.data())
                
                // DB에 저장되어있는 내용 가져와서 DB에 저장
                var document_bookcover = 결과.data().bookcover;
                var document_information_title = 결과.data().name;
                var document_information_publisher = 결과.data().publisher;
                var document_information_author = 결과.data().author;
                var document_information_genre = 결과.data().genre;
                var document_information_buy_series_name = 결과.data().buy_series;
                var document_information_buy_series_address = 결과.data().address;
                var document_information_publish_date = 결과.data().publish_date;
                var document_summary_content = 결과.data().summary;
                var document_information_birthday = 결과.data().author_birthday;
                
                
                // 추후에 입력, 순서대로 좋아요개수, 업로드 날짜, 조회수, 태그, 기타
                document_like = 결과.data().like;
                var document_update_date = 결과.data().update_date;
                document_view = 결과.data().view;
                var document_tag = 결과.data().tag;
                var document_other = 결과.data().other;

                // 평점 불러오기
                star_cal = (결과.data().star / 결과.data().star_count).toFixed(2);

                document.getElementById("document_information_star").innerText= star_cal;

                // 태그 불러오기 영역
                console.log(typeof(document_tag));
                document_tag.forEach(function(tag_element){
                    var tag_temp = `<a href="../search?q=!${tag_element}">${"#"+tag_element}</a>`
                    $('#document_tag_area').append(tag_temp);
                });

                // 타임스템프 변환
                var timestamp_second = document_update_date.seconds * 1000;
                var time = new Date(timestamp_second);
                var year = time.getFullYear().toString().slice(-4) + "년 ";
                var month = ("0" + (time.getMonth() + 1)).slice(-2) + "월 ";
                var day = ("0" + time.getDate()).slice(-2) + "일 ";
                var hour = ("0" + time.getHours()).slice(-2) + "시 ";
                var minute = ("0" + time.getMinutes()).slice(-2) + "분 ";
                var second = ("0" + time.getSeconds()).slice(-2) + "초";

                // 줄거리 더보기 버튼 제거
                if(document_summary_content.length<650){
                    document.getElementById("more_button").style.display = 'none';
                    document.getElementById("summary_content").style.borderBottomRightRadius = '15px';
                    document.getElementById("summary_content").style.borderBottomLeftRadius = '15px';
                }

                // 표지변경
                console.log(document_bookcover);
                document.getElementById("document_bookcover").src = document_bookcover;

                document.getElementById("document_information_title").innerText = document_information_title;
                document.getElementById("document_information_author").innerText = document_information_author;
                document.getElementById("document_information_author").href = '../a/' + document_information_author + '(' + document_information_birthday + ')';
                document.getElementById("document_information_publisher").innerText = document_information_publisher;
                document.getElementById("document_information_publisher").href = '../p/' + document_information_publisher;

                document.getElementById("document_information_genre").innerText = document_information_genre;
                
                document.getElementById("document_information_buy_series").innerText = document_information_buy_series_name;

                document.getElementById("view_get").innerText = document_view + "회";
                document.getElementById("update_get").innerText = year + month + day + hour + minute + second;
                document.getElementById("like_count").innerText = document_like;
                // document.getElementById("like_count").value = document_like;

                const address_analze = document_information_buy_series_address.split(":");
                console.log(address_analze[0]);

                if(address_analze[0]==="http" || address_analze[0]==="https"){
                    document.getElementById("document_information_buy_series").href = document_information_buy_series_address;
                }
                else{
                    document.getElementById("document_information_buy_series").href = "https://www.google.com/search?q=" + document_information_buy_series_address;
                }

                document.getElementById("document_information_publish_date").innerText = document_information_publish_date;
                document.getElementById("document_summary_content").innerText = document_summary_content;

                document.getElementById("document_other").innerHTML = document_other;
                // document.getElementById("document_information_author").innerText = document_information_author;
                // document.getElementById("document_information_author").innerText = document_information_author;
                // document.getElementById("document_information_author").innerText = document_information_author;
            }).catch((err) => {
                console.log(err);
                document.getElementById("document_section").style.display = "none";
                const empty = `<div class="empty_page"> <div class="empty_result_area"> <div class="empty_none">
                        <div class="text_bundle">
                            <p class="warning">ⓘ</p><p id ="this_document">해당문서</p><p class="alram">에 대한 문서 정보가 없습니다.</p>
                        </div>
                        <div class="button_bundle">
                            <a href="#" class="new_document" id="new_document">새 문서 작성하기</a>
                            <a href="#" class="history" id="history_document">역사</a>
                        </div>
                    </div>
                </div></div>`
                
                document.getElementById('section_empty').style.display = 'block';
                document.getElementById('empty').innerHTML = empty;
                document.getElementById('this_document').innerText = document_name[2];
                document.getElementById('new_document').href = '../e/' + document_name[2];
                document.getElementById('history_document').href = '../h/' + document_name[2];
            });
        }
    </script>


    <script>
        var user_class = "nu";

        $('#go_delete').click(function(){
            if(confirm("정말 '" + document_name[2] + "'문서를 삭제하시겠습니까?")){
                db.collection('novel_document').doc(document_name[2]).delete().then(async function() {
                    if(login_check == true){
                        ip_address_info = user_id;
                        user_class = login_user_class;
                    }
                    await history_data_update();
                    await history_update();
                    console.log("문서 삭제 완료");
                }).catch(function(error) {
                    console.error("Error removing document: ", error);
                });
            }
            else{

            }
        });

        async function history_data_update(){
            return await db.collection('history').doc(document_name[2]).collection('data').doc('count').update({
                version: firebase.firestore.FieldValue.increment(1),
            })
            .then(async () => {
                alert("history data 업데이트 성공!");                
            }).catch((err)=>{
                console.log(err + "history data 업데이트 실패!")
            });
        }

        async function history_update(){
            var info = {
                bookcover: data_save_array.data().bookcover,
                name: data_save_array.data().name,
                name_keyword: data_save_array.data().name_keyword,
                author: data_save_array.data().author,
                author_birthday : data_save_array.data().author_birthday,
                publisher: data_save_array.data().publisher,
                n_category: data_save_array.data().n_category,
                genre: data_save_array.data().genre,
                buy_series: data_save_array.data().buy_series,
                address: data_save_array.data().address,
                publish_date: data_save_array.data().publish_date,
                tag: data_save_array.data().tag,
                summary: data_save_array.data().summary,
                other: data_save_array.data().other,
                the_first_date: data_save_array.data().the_first_date,
                version: data_save_array.data().version + 1,
                update_date:new Date(),
                category: data_save_array.data().category,
                final_modify: ip_address_info,
                user_class: user_class,
                action: "d",                               
            };
            console.log(document_name[2]);
            await db.collection('history').doc(document_name[2]).collection('version').doc((data_save_array.data().version + 1).toString()).set(info).then((result) => {
                console.log(result);
                alert("history data success.");
                location.reload();
            }).catch((error) => {
                console.log(error);
                alert("history data failed.");
            });

        }
    </script>
    
    <style>
        .section_empty {
            margin-top: 100px;
            margin-bottom: 100px;
            width: 100%;
            display: none;
        }

        .empty_page {
            width: auto;
            height: auto;
            margin-left: 150px;
            margin-right: 150px;
        }

        #empty{
            
        }

        .empty_result_area {
            min-height: 600px;
            height: auto;
            border: 1px solid black;
            /*background-color: #f7fbfc;*/
        }
        .empty_none {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            margin-left: 20px;
            margin-right: 20px;
            margin-top: 15px;
            width: auto;
            height: 100px;
            border: 1px solid #e5e5e5;
            background-color:#f6f6f6;
        }

        .empty_none .button_bundle {
            display: flex;
            justify-content: flex-end;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .empty_none .text_bundle {
            display: flex;
        }

        .empty_none a {
            text-decoration: none;
            padding: 5px;
            padding-left: 30px;
            padding-right: 30px;
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            border: 1px solid #c7c3c3;
            color: gray;
            background-color: #fff;
        }

        .empty_none .new_document {
            color: #769fcd;
        }

        .empty_none .history {
            border-left: none;
            color: #1fa73b;
        }

        .empty_none p {
            margin-bottom: 5px;
            margin-left: 5px;
            margin-top: 10px;
        }

        .empty_none .alram {
            margin-left: 0px;
        }

        .empty_none .warning {
            font-weight: 600;
            margin-top: 11px;
            transform: rotate(180deg);
        }

        @media (max-width: 870px){
            .empty_page {
                margin-left: 30px;
                margin-right: 30px;
           }
        }
    </style>
    
    <!-- <script src="../js/like.js"></script> -->

</body>

</html>