<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/header.css" rel="stylesheet">
    <link href="css/footer.css" rel="stylesheet">
    <link href="css/mypage_menubar.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/review_record.css">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
    <title>작성 리뷰</title>
</head>
<body class="review_body">
    <input type="checkbox" id="menuicon">
    <label for="menuicon">
        <span></span>
        <span></span>
        <span></span>
    </label>

    <nav class="mypage_sidebar">
        <div class="mypage_menubar_content">
            <div class="mypage_title"><a href="user_modify.html">마이페이지</a>
            </div>

            <div class="mypage_imformation"><a href="user_modify.html">회원정보</a>
            </div>

            <div class="mypage_library">
                <input type="checkbox" id="answer01">
                <label for="answer01">
                    <div class="mypage_mtitle">내 서재</div>
                </label>

                <div class="mypage_list">
                    <div class="mypage_set1">
                        <div class="mypage_picture"><a href="#">작품</a></div>
                    </div>

                    <div class="mypage_set1">
                        <div class="mypage_author"><a href="#">작가</a></div>
                    </div>

                    <div class="mypage_set1">
                        <div class="mypage_publisher"><a href="#">출판사</a></div>
                    </div>

                    <div class="mypage_under_bar_boxing">
                        <div class="mypage_under_bar"></div>
                    </div>

                    <div class="mypage_set1">
                        <div class="mypage_visit"><a href="view_record.html">열람기록</a></div>
                    </div>
                </div>
            </div>

            <div class="mypage_review"><a href="review_record.html">리뷰</a></div>
        </div>
        <div class="mypage_leave">
            <div class="mypage_delete"><a href="#">회원탈퇴</a></div>
        </div>
    </nav>
    
    <header class="header">
        <a class="logo_a" href="http://novelpedia.co.kr">
            <!--<img class="logo" src="./image/novelpedia.png" height="40px">-->
            <img class="logo_icon" src="image/logo.png">
        </a>
        <div class="first_line">
            <div class="inner_item">
                <a id="open_close" href="#" class="navbar_toggleBtn">
                    <img id="close" src="image/메뉴_검정_버튼.png">
                </a>
                <div class="inner_inner_item">
                    <div class="search">
                        <div class="icon"></div>
                        <form method="get" action="search">
                            <div class="input">
                                <input type="text" placeholder="Search" id="mysearch" name="q">
                            </div>
                            <span class="clear" onclick="document.getElementById('mysearch').value = ''"></span>
                            <input type="submit" value="" class="search_btn">
                        </form>
                    </div>
                </div>
            </div>
            <div class="set">
                <div class="set_mid">
                    <ul class="bar_menu">
                        <input type="checkbox" id="list_open">
                        <label for="list_open" class="list_page_label">
                            <li class="list_li">목록페이지</li>
                            <div class="header_list">
                                <div class="header_set1">
                                    <div class="header_picture"><a href="list/novel">작품</a></div>
                                </div>
                                <div class="header_set1">
                                    <div class="header_author"><a href="list/author">작가</a></div>
                                </div>
            
                                <div class="header_set1">
                                    <div class="header_publisher"><a href="list/publisher">출판사</a></div>
                                </div>
                            </div>
                        </label>
                        <li class="mypage_header" id="mypage_button"><a href="mypage">마이페이지</a></li>
                        <li><a href="login" id="login_logout">Login</a></li>
                    </ul>
                </div>
            </div>
        </div>

    </header>

    <script>
        /*메뉴버튼 바꾸기 위한 변수*/
        const change_img = document.createElement('img');
        change_img.setAttribute('src', './image/메뉴_닫힘.png');
        change_img.setAttribute('id', 'close');

        const change_img_normal = document.createElement('img');
        change_img_normal.setAttribute('src', './image/메뉴_검정_버튼.png');
        change_img_normal.setAttribute('id', 'close');

        /*검색버튼에 대한 동작 변수*/
        const icon = document.querySelector('.search .icon');
        const search = document.querySelector('.search');
        const inner_item = document.querySelector('.inner_item');
        const inner_inner_item = document.querySelector('.inner_inner_item');
        const menu_window2 = document.querySelector('.header .set active');

        /*메뉴 버튼에 따른 동작 변수*/
        const toggleBtn = document.querySelector('.navbar_toggleBtn');
        const menu = document.querySelector('.bar_menu');
        const menu_window = document.querySelector('.header .set');

        /*메뉴버튼*/
        toggleBtn.onclick = function() {
            menu.classList.toggle('active');
            menu_window.classList.toggle('active');
            const lastDiv = document.getElementById('close');
            /*메뉴창 열림 여부에 따라 버튼 이미지 교체*/
            if (document.querySelector('.header .set').classList.contains('active')) {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img);
            } else {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img_normal);
            }

        }

        /*검색버튼*/
        icon.onclick = function() {
            icon.classList.toggle('active');
            search.classList.toggle('active');
            inner_item.classList.toggle('active');
            inner_inner_item.classList.toggle('active');
            menu_window.classList.toggle('search_active');
        }
    </script>
   
    <section class="view_section_all">            
        <div class="container">
            <div class="banner">작성한 리뷰</div>
        </div>
        <div class="top">
            <div class="view_set">
                <input type="checkbox" id="all_check" onclick="allCheck(this)">
                <label for="all_check" class="all_choice">모두 선택</label>
                <a class="delete" onclick="checkDelete()">삭제</a>
            </div>
        </div>
        <div class="top">
            <div class="view_search">
                <div class="view_search_bar">
                    <input type="text" placeholder="검색기록" name="q">
                    <button onclick="location.href='address'"><img src="./image/search_view.png"></button>
                </div>
            </div>
        </div>
        <div class="table_all">
            <div class="table_set">
                <!-- <div class="table_row_date">
                    <div class="col_0">오늘 - 2022년 10월 31일 월요일</div>
                </div>
                <div class="table_row">
                    <div class="col_1"><input type="checkbox" name="choice" value="1"></div>
                    <div class="col_2">시간</div>
                    <div class="col_3"><a href="">제목</a></div>
                    <div class="col_4"><a href="">작가</a></div>
                    <div class="col_5"><a href="">리뷰내용</a></div>
                    <div class="col_6"><a href="">별점</a></div>
                    <div class="col_7"><a href="">삭제</a></div>
                </div> -->
            </div>
        </div>
    </section>
    
    
    
    
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="footer-col">
                    <ul>
                        <li><a href="#">공지사항</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">Q&A</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="#">의견보내기</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!--파이어베이스 연동 자바스크립트 파일-->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <!--제이쿼리-->
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    
    <!--파이어베이스 정보 가져오기--><!--파이어베이스 연동 키값-->
    <script src="./js/information.js"></script>

    <!--로그인 상태 체크-->
    <script src="./js/login_check.js"></script>
    <!--로그아웃을 위한 소스코드-->
    <script src="./js/logout.js"></script>
    <!--로그아웃 상태일 때-->
    <script src="./js/logout_state.js"></script>

    <!-- 문서 열면서 동기적으로 실행할 함수 -->
    <script>
        async function start_novel(){
                await getUser();
                await getReviewInfor();
                console.log(login_user_information);
            }
        start_novel();
    </script>

    <!-- 파이어베이스 데이터 출력 -->
    <script>
        var lastVisible;
        var save_review_date;
        let review_save = [];
        let review_save_count = 0;

        async function getReviewInfor() {
            const dbRef = db.collection("user").doc(login_user_information).collection("review").orderBy("date", "desc").limit(10);
            try{
                const res = await dbRef.get();
                lastVisible = res.docs[res.docs.length-1];

                res.forEach((doc)=>{
                    console.log("data: " + doc.data());
                    review_save[review_save_count] = doc.data();
                    

                    var review_date = doc.data().date;

                    // 타임스템프 변환
                    var timestamp_second = review_date.seconds * 1000;
                    var time = new Date(timestamp_second);
                    var year = time.getFullYear().toString().slice(-4) + "년 ";
                    var month = ("0" + (time.getMonth() + 1)).slice(-2) + "월 ";
                    var day = ("0" + time.getDate()).slice(-2) + "일 ";
                    var hour = ("0" + time.getHours()).slice(-2) + "시 ";
                    var minute = ("0" + time.getMinutes()).slice(-2) + "분 ";
                    // var second = ("0" + time.getSeconds()).slice(-2) + "초";

                    var non_time_date = year + month + day;
                    var time_date = hour + minute;

                    
                    var date_temp =
                        `<div class="table_row_date">
                            <div class="col_0">${non_time_date}</div>
                        </div>`

                    var temp = 
                        `<div class="table_row">
                            <div class="col_1"><input type="checkbox" name="choice" value="${review_save_count}"></div>
                            <div class="col_2">${time_date}</div>
                            <div class="col_3"><a href="./n/${doc.data().d_name}">${doc.data().name}</a></div>
                            <div class="col_4"><a>${doc.data().author}</a></div>
                            <div class="col_5"><a>${doc.data().content}</a></div>
                            <div class="col_6"><a>${doc.data().star}</a></div>
                            <div class="col_7" onclick="review_delete(${doc.data().star + ", '" + doc.data().d_name  + "' "})">삭제</div>
                        </div>`;

                    if(save_review_date == non_time_date){
                    }
                    else{
                        $('.table_set').append(date_temp);
                        save_review_date = year + month + day
                    }

                    $('.table_set').append(temp);
                    review_save_count = review_save_count + 1;
                })
                
            }
            catch(error){
                console.log('Error getting document:', error);
            }
        }

        var loading = false;
        var scrollHeight_original = document.documentElement.scrollHeight;
        var scroll_count = 0;

        window.addEventListener('scroll', async function() {
            if(scroll_count==0){
                scrollHeight_original = document.documentElement.scrollHeight;
                scroll_count = scroll_count + 1;
            }

            // 스크롤 이벤트 핸들러
            var scrollTop = document.documentElement.scrollTop; // 현재 스크롤 위치
            var scrollHeight = document.documentElement.scrollHeight; // 전체 문서 높이

            // console.log(scrollTop);
            // console.log(Math.ceil(scrollTop + window.innerHeight));
            // console.log(scrollHeight);
            // console.log(loading);
            // console.log("original : " + scrollHeight_original);

            if(scrollHeight_original == scrollHeight){
                console.log("같음 실행");
            }
            else{
                scroll_count = 0;
                loading = false;
                console.log("다름 실행");
            }

            if (Math.ceil(scrollTop + window.innerHeight) >= scrollHeight && !loading) {
                console.log("실행");
                loading = true;
                await next_review();
                
                    
            }
            
        });

        async function next_review(){
            var next = db.collection("user").doc(login_user_information).collection("review").orderBy("date", "desc").startAfter(lastVisible).limit(10);
            try{
                const res = await next.get();
                console.log("test");
                lastVisible = res.docs[res.docs.length-1];

                res.forEach((doc)=>{
                    review_save[review_save_count] = doc.data();
                    
                    console.log("data: " + doc.data());
                    

                    var review_date = doc.data().date;

                    // 타임스템프 변환
                    var timestamp_second = review_date.seconds * 1000;
                    var time = new Date(timestamp_second);
                    var year = time.getFullYear().toString().slice(-4) + "년 ";
                    var month = ("0" + (time.getMonth() + 1)).slice(-2) + "월 ";
                    var day = ("0" + time.getDate()).slice(-2) + "일 ";
                    var hour = ("0" + time.getHours()).slice(-2) + "시 ";
                    var minute = ("0" + time.getMinutes()).slice(-2) + "분 ";
                    // var second = ("0" + time.getSeconds()).slice(-2) + "초";

                    var non_time_date = year + month + day;
                    var time_date = hour + minute;

                    
                    var date_temp =
                        `<div class="table_row_date">
                            <div class="col_0">${non_time_date}</div>
                        </div>`

                    var temp = 
                        `<div class="table_row">
                            <div class="col_1"><input type="checkbox" name="choice" value="${review_save_count}"></div>
                            <div class="col_2">${time_date}</div>
                            <div class="col_3"><a href="./n/${doc.data().d_name}">${doc.data().name}</a></div>
                            <div class="col_4"><a>${doc.data().author}</a></div>
                            <div class="col_5"><a>${doc.data().content}</a></div>
                            <div class="col_6"><a>${doc.data().star}</a></div>
                            <div class="col_7" onclick="review_delete(${doc.data().star + ", '" + doc.data().d_name  + "' "})">삭제</div>
                        </div>`;

                    if(save_review_date == non_time_date){
                    }
                    else{
                        $('.table_set').append(date_temp);
                        save_review_date = year + month + day
                    }

                    $('.table_set').append(temp);
                    review_save_count = review_save_count + 1;
                })
            }
            catch(error){
                console.log('Error getting document:', error);
            }
        }

        // 리뷰 삭제시 작품문서 평점 초기화
        async function reviewDimCounter(star_t, document_n){
            const docRef = db.collection('novel_document').doc(document_n);
            return await docRef.update({
                star: firebase.firestore.FieldValue.increment(-star_t),
                star_count: firebase.firestore.FieldValue.increment(-1)
            }).then(()  => {
                console.log("좋아요 제거 성공");
            }).catch((error) => {
                console.log(error);
            });
        }

        // 리뷰 삭제시 역사 문서 평점 초기화
        async function historyReviewDimCounter(star_t, document_n){
            const docRef = db.collection('history').doc(document_n).collection('data').doc('count');
            return await docRef.update({
                star: firebase.firestore.FieldValue.increment(-star_t),
                star_count: firebase.firestore.FieldValue.increment(-1)
            }).then(()  => {
                console.log("역사 좋아요 제거 성공");
            }).catch((error) => {
                console.log("역사 실패", error);
            });
        }

        async function review_delete_user(document_n){
            const docRef = db.collection('user').doc(login_user_information).collection('review').doc(document_n);
            await docRef.delete().then(async (result) => {
                console.log("user 정보 삭제 완료");
            }).catch((error) => {
                console.log(error);
                alert("user delete failed.");
            });
        }

        async function review_delete(star_t, document_n, usage = "d"){
            let review_path = db.collection('review').doc(document_n).collection('short').doc(login_user_information);
            
            await review_path.delete().then(async (result) => {
                await reviewDimCounter(star_t, document_n);
                await historyReviewDimCounter(star_t, document_n)
                await review_delete_user(document_n);
                if(usage=="d"){
                    location.reload();
                }
            }).catch((error) => {
                console.log(error);
                alert("delete failed.");
            });
        }

        function allCheck(selectAll){
            const checkboxs = document.getElementsByName('choice');
            
            checkboxs.forEach((checkbox) => {
                checkbox.checked = selectAll.checked;
            })
        }

        async function checkDelete(){
            const promises = [];

            $('input:checkbox[name=choice]').each(async function (index) {
                if($(this).is(":checked")==true){
                    console.log(review_save[$(this).val()].star);
                    promises.push(review_delete(review_save[$(this).val()].star, review_save[$(this).val()].d_name, "ad"));
                }
            });

            await Promise.all(promises)
            await location.reload();
        }
    </script>
</body>
</html>