<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
    <link href="../css/edit_author.css" rel="stylesheet">
    <link href="../css/header.css" rel="stylesheet">
    <link href="../css/footer.css" rel="stylesheet">
    <link href="../css/web_editor.css" rel="stylesheet">
    <link href="../css/loading.css" rel="stylesheet">
    <title>편집</title>
</head>

<body>
    <header class="header">
        <a class="logo_a" href="../index.html">
            <!--<img class="logo" src="./image/novelpedia.png" height="40px">-->
            <img class="logo_icon" src="../image/logo.png">
        </a>
        <div class="first_line">
            <div class="inner_item">
                <a id="open_close" href="#" class="navbar_toggleBtn">
                    <img id="close" src="../image/메뉴_검정_버튼.png">
                </a>
                <div class="inner_inner_item">
                    <div class="search">
                        <div class="icon"></div>
                        <form method="get" action="../search">
                            <div class="input">
                                <input type="text" placeholder="Search" id="mysearch" name="q">
                            </div>
                            <span class="clear" onclick="document.getElementById('mysearch').value = ''"></span>
                            <input type="submit" value="" class="search_btn">
                        </form>
                    </div>
                </div>
            </div>
            <div class="set">
                <div class="set_mid">
                    <ul class="bar_menu">
                        <input type="checkbox" id="list_open">
                        <label for="list_open" class="list_page_label">
                            <li class="list_li">목록페이지</li>
                            <div class="header_list">
                                <div class="header_set1">
                                    <div class="header_picture"><a href="../list/novel">작품</a></div>
                                </div>
                                <div class="header_set1">
                                    <div class="header_author"><a href="../list/author">작가</a></div>
                                </div>
            
                                <div class="header_set1">
                                    <div class="header_publisher"><a href="../list/publisher">출판사</a></div>
                                </div>
                            </div>
                        </label>
                        <li class="mypage_header" id="mypage_button"><a href="../mypage">마이페이지</a></li>
                        <li><a href="../login" id="login_logout">Login</a></li>
                    </ul>
                </div>
            </div>
        </div>

    </header>

    <script>
        /*메뉴버튼 바꾸기 위한 변수*/
        const change_img = document.createElement('img');
        change_img.setAttribute('src', '../image/메뉴_닫힘.png');
        change_img.setAttribute('id', 'close');

        const change_img_normal = document.createElement('img');
        change_img_normal.setAttribute('src', '../image/메뉴_검정_버튼.png');
        change_img_normal.setAttribute('id', 'close');

        /*검색버튼에 대한 동작 변수*/
        const icon = document.querySelector('.search .icon');
        const search = document.querySelector('.search');
        const inner_item = document.querySelector('.inner_item');
        const inner_inner_item = document.querySelector('.inner_inner_item');
        const menu_window2 = document.querySelector('.header .set active');

        /*메뉴 버튼에 따른 동작 변수*/
        const toggleBtn = document.querySelector('.navbar_toggleBtn');
        const menu = document.querySelector('.bar_menu');
        const menu_window = document.querySelector('.header .set');

        /*메뉴버튼*/
        toggleBtn.onclick = function() {
            menu.classList.toggle('active');
            menu_window.classList.toggle('active');
            const lastDiv = document.getElementById('close');
            /*메뉴창 열림 여부에 따라 버튼 이미지 교체*/
            if (document.querySelector('.header .set').classList.contains('active')) {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img);
            } else {
                document.getElementById('open_close').removeChild(lastDiv);
                document.getElementById('open_close').appendChild(change_img_normal);
            }

        }

        /*검색버튼*/
        icon.onclick = function() {
            icon.classList.toggle('active');
            search.classList.toggle('active');
            inner_item.classList.toggle('active');
            inner_inner_item.classList.toggle('active');
            menu_window.classList.toggle('search_active');
        }
    </script>

    <div class="loading_box" id="loading_box">
        <div class="loading-container">
            <div class="loading"></div>
            <div id="loading-text">loading</div>
        </div>
    </div>

    <section class="document_item">
        <div class="document_name">
            <a href="#" id="document_name">작가명(생년월일)</a>
        </div>
        <div class="page_title">
            <h4>[문서 정보 편집]</h4>
        </div>
        <form action="#">
            <div class="document_critical_edit">
                <!--프로필사진-->
                <div class="document_profile_image_edit">
                    <label class="label" for="profile_image_file">프로필사진</label>
                    <img id="profile_image_preview" class="profile_image_preview" for="profile_image_file" src="../image/표지_미등록.png">
                    <input class="profile_image_upload" id="profile_image_file" type="file" accept="image/*" onchange="loadFile(this)">
                </div>
                <!--작가이름-->
                <div class="document_name_edit">
                    <label class="label" for="name">이름</label>
                    <input id="name" type="text" autocomplete="off">
                </div>
                <!--출생-->
                <div class="document_native_edit">
                    <label class="label" for="native">출생</label>
                    <input id="native" type="text" autocomplete="off">
                </div>
                <!--생년월일-->
                <div class="document_birthday_edit">
                    <label class="label" for="birthday">생년월일</label>
                    <div class="birthday_warning">
                        <input id="birthday" type="date" autocomplete="off">
                        <div class="checkbox_pakage">
                            <input id="birthday_check" type="checkbox" onclick="isCheck()">
                            <span> ※생년월일을 알 수 없는 경우 체크해주십시오※</span>
                        </div>
                        <span class="span">※경고:생년월일을 변경하면 문서가 새로 생성됩니다.※</span>
                    </div>
                </div>
                <!--등단일-->
                <div class="document_debutdate_edit">
                    <label class="label" for="debutdate">등단일</label>
                    <input id="debutdate" type="date" autocomplete="off">
                </div>
                <!--최근출간일-->
                <div class="document_recent_publishdate_edit">
                    <label class="label" for="recent_publishdate">최근 출간일</label>
                    <input id="recent_publishdate" type="date" autocomplete="off">
                </div>
                <!--대표작품-->
                <div class="document_main_novel_edit">
                    <label class="label" for="main_novel">대표작품</label>
                    <input id="main_novel" type="text" autocomplete="off">
                </div>
                <!--최근작품-->
                <div class="document_recent_novel_edit">
                    <label class="label" for="recent_novel">최근작품</label>
                    <input id="recent_novel" type="text" autocomplete="off">
                </div>
                <!--학력-->
                <div class="document_school_edit">
                    <label class="label" for="school">학력</label>
                    <input id="school" type="text" autocomplete="off">
                </div>
                <!--소속-->
                <div class="document_company_edit">
                    <label class="label" for="company">소속</label>
                    <input id="company" type="text" autocomplete="off">
                </div>
                <!--태그-->
                <div class="document_tag_edit">
                    <label class="label" for="tag">태그</label>
                    <div class="content">
                        <!--<p>Enter 키를 누르거나 쉼표(,) 키를 추가하십시오.</p>-->
                        <ul id="tag_area"><textarea id="tag" maxlength="50"></textarea></ul>
                        <div class="details">
                            <p><span>0</span> / 30</p>
                            <!--<button>모두 제거</button>-->
                        </div>
                    </div>
                </div>
            </div>
            <!--사용자편집영역-->
            <div class="document_other_edit">
                <!--웹에디터 추가 영역-->
                <div class="webeditor">
                    <div class="editor_button">
                        <input type="button" class="button" id="header" onclick="addHeader()" value="제목">
                        <input type="button"  class="button" id="body" onclick="addBody()" value="본문">
                        <input type="button"  class="button" id="add-horizontal-rule" value="가로줄">
                        <input type="button"  class="button" id="link-btn" value="링크">
                        <input type="button"  class="button" id="upload-image-btn" onclick="image_upload()" value="이미지">
                        <input type="button"  class="button" id="convertBtn" onclick="convertFormat()" value="변환(HTML → Text)">
                    </div>
                    <div id="editor" contenteditable="true"></div>
                    <!-- <textarea id="document_other"></textarea> -->
                </div>
            </div>
            <!--각종버튼-->
            <div class="button_bundle">
                <input class="save" id="send" type="button" value="저장">
                <a onclick="history.back()">취소</a>
                <!--<input type="button" value="취소">-->
                <a class="delete" id="go_delete">삭제</a>
            </div>
        </form>
    </section>

    <script>
        function loadFile(input) {
            var file = input.files[0];
            var changeImage = document.getElementById("profile_image_preview");
            changeImage.src = URL.createObjectURL(file);
        };
    </script>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="footer-col">
                    <ul>
                        <li><a href="../notice">공지사항</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <ul>
                        <li><a href="../report">신고 및 건의</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="../js/information.js"></script>

    <!--로그인 상태 체크-->
    <script src="../js/login_check.js"></script>
    <!--로그아웃을 위한 소스코드-->
    <script src="../js/logout.js"></script>
    <!--로그아웃 상태일 때-->
    <script src="../js/logout_state.js"></script>

    <!-- 웹에디터 -->
    <script src="../js/web_editor.js"></script>

    <!--태그 입력-->
    <script src="../js/tag.js"></script>

    <!-- 아이피주소 가져오기 -->
    <script>
        var ip_address_info;
        $.getJSON("https://ipinfo.io", function(data) {
            ip_address_info = data.ip;
        })
    </script>

    <script>
        const path_url = window.location.pathname;
        const path_decode = decodeURI(path_url);
        const document_name = path_decode.split('/');
        document.getElementById('document_name').innerText = document_name[2];
        document.getElementById("document_name").href = "../a/" + document_name[2];

        // 타이틀 변경
        // console.log(document_name[2]);
        document.title = document_name[2];

        var document_profilecover = 'https://novelpedia2223-2ce3c.web.app/image/%ED%91%9C%EC%A7%80_%EB%AF%B8%EB%93%B1%EB%A1%9D.png';
        var document_version = 0;
        var document_the_first_date = new Date();
        var document_category = "a";
        let data_save_array = [];
        
        $('#loading_box').show();

        if(document_name[2].length == 0){
            document_name[2] = 'novelpedia';
        }

        db.collection('author_document').doc(document_name[2]).get().then((결과) => {
            data_save_array = 결과;
            // 불러온 내용 바탕으로 내용 바꾸기
            // console.log(결과.data())
            
            // DB에 저장되어있는 내용 가져와서 DB에 저장
            document_profilecover = 결과.data().profilecover;
            var document_information_name = 결과.data().name;
            var document_information_native = 결과.data().native;
            var document_information_birthday = 결과.data().birthday;
            var document_information_debutdate = 결과.data().debutdate;
            var document_information_recent_publishdate = 결과.data().recent_publishdate;
            var document_information_main_novel = 결과.data().main_novel;
            var document_information_recent_novel = 결과.data().recent_novel;
            var document_information_school = 결과.data().school;
            var document_company = 결과.data().company;
            
            
            // 추후에 입력, 순서대로 좋아요개수, 업로드 날짜, 조회수, 태그, 기타
            var document_like = 결과.data().like;
            var document_upload_date = 결과.data().upload_date;
            var document_view = 결과.data().view;
            var document_tag = 결과.data().tag;
            var document_other = 결과.data().other;

            document_version = 결과.data().version;
            document_the_first_date = 결과.data().the_first_date;
            document_category = 결과.data().category;

            // 타이틀 변경
            // document.title = document_name[2];
            
            // 편집, 역사 페이지 버튼 주소 초기화
            // document.getElementById("go_history").href = "../h/" + document_name[2];

            // 표지 미리보기 변경
            // console.log(document_bookcover);

            if(document_information_birthday=='0001-01-01'){
                document.getElementById("birthday").value = document_information_birthday;
                document.getElementById("birthday_check").disabled = false;
            }
            else{
                document.getElementById("birthday").value = document_information_birthday;
                document.getElementById("birthday").disabled = true;
                document.getElementById("birthday_check").disabled = true;
                // console.log("not, 0001-01-01");                
            }

            document.getElementById("profile_image_preview").src = document_profilecover;

            document.getElementById("name").value = document_information_name;
            document.getElementById("name").disabled = true;
            

            document.getElementById("native").value = document_information_native;
            document.getElementById("debutdate").value = document_information_debutdate;
            document.getElementById("recent_publishdate").value = document_information_recent_publishdate;
            document.getElementById("main_novel").value = document_information_main_novel;
            document.getElementById("recent_novel").value = document_information_recent_novel;
            document.getElementById("school").value = document_information_school;
            document.getElementById("company").value = document_company;

            // 태그 입력
            document_tag.forEach(function(tag_element){
                tags.push(tag_element);
            });
            countTags();
            createTag();

            document.getElementById("editor").innerHTML = document_other;

            $('#loading_box').hide()
        }).catch((err) => {
            $('#loading_box').hide()
            console.log(err);
        });
    </script>

    <!-- 파이어베이스 데이터 등록 -->
    <script>
        const storage = firebase.storage();
        // 영어는 소문자로 저장
        // var name_keyword_temp_lower = [];
        var user_class = "nu";

        $('#send').click(async function(){
            $('#loading_box').show()
            // 로그인이 되어있다면, IP주소를 사용자의 아이디로 바꾸기
            if(login_check == true){
                ip_address_info = user_id;
                user_class = login_user_class;
            }
            await outputKeyword();
            await data_check();
            await data_saving();
            $('#loading_box').hide()
        })

        var view_temp = 0;
        var like_temp = 0;
        // var version_temp = 1;

        let keywordTemp3 = [];

        function outputKeyword() {
            const keyword = document.getElementById("name").value.toLowerCase();
            const keywordLen = keyword.length;
            const keywordTemp = [];

            for(let i=0; i< keywordLen; i++) {
                for(let j=i+1; j<=keywordLen; j++){
                    // 글자 수 만큼 분리
                    const temp = keyword.substr(i, j-i).trim();
                    const regex = /[^a-zA-Z0-9가-힣]/g;
                    const filteredSubstr = temp.replace(regex, "");
                    if(filteredSubstr !== "") {
                        keywordTemp.push(filteredSubstr);
                    }
                }
            }
            
            const name_keyword_temp = [ 
                keyword.split(/[\s]+/),
                keyword.split(/은\s+/),
                keyword.split(/의\s+/),
                keyword.split(/에\s+/),
                keyword.split(/는\s+/),
                keyword.split(/이\s+/),
                keyword.split(/가\s+/),
                keyword.split(/만\s+/),
                keyword.split(/뿐\s+/),
                keyword.split(/밖에\s+/),
                keyword.split(/도\s+/),
                keyword.split(/까지\s+/),
                keyword.split(/마저\s+/),
                keyword.split(/조차\s+/),
                keyword.split(/은\s+/),
                keyword.split(/나\s+/),
                keyword.split(/이나\s+/),
                keyword.split(/라도\s+/),
                keyword.split(/이라도\s+/),
                keyword.split(/든지\s+/),
                keyword.split(/이든지\s+/),
                keyword.split(/이나마\s+/),
                keyword.split(/나마\s+/),
                keyword.split(/,\s+/),
                keyword.split(/"\s+/),
                keyword.split(/,\s+&\s+/),
                keyword.split('/'),
                keyword.split('?'),
                keyword.split(/!\s+/),
                keyword.split(/@\s+/),
                keyword.split(/#\s+/),
                keyword.split('$'),
                keyword.split(/%\s+/),
                keyword.split('^'),
                keyword.split(/&\s+/),
                keyword.split('*'),
                keyword.split('('),
                keyword.split(')'),
                keyword.split(/-\s+/),
                keyword.split(/_\s+/),
                keyword.split('+'),
                keyword.split(/=\s+/),
                keyword.split(/<\s+/),
                keyword.split(/>\s+/),
                keyword.split(/.\s+/),
                keyword.split('|'),
                keyword.split(/`\s+/),
                keyword.split(/~\s+/),
                keyword.split('['),
                keyword.split(']'),
                keyword.split('{'),
                keyword.split('}'),
                keyword.split(/」\s+/),
                keyword.split(/「\s+/),
                keyword.split(/,[\s]+/),
                keyword.split(/"\s+/),
                keyword.split(/1\s+/),
                keyword.split(/2\s+/),
                keyword.split(/3\s+/),
                keyword.split(/4\s+/),
                keyword.split(/5\s+/),
                keyword.split(/6\s+/),
                keyword.split(/7\s+/),
                keyword.split(/8\s+/),
                keyword.split(/9\s+/),
                keyword.split(/0\s+/)
            ];

            const name_keyword_temp2 = flattenArray(name_keyword_temp).filter(element => element.trim() !== '').map(element => element.replace(/[^\w\s]/gi, '')).map(element => element.replace(/[\s]/gi, ''));
            // 공백 또는 빈 문자열 제거
            keywordTemp3 = [...new Set(name_keyword_temp2.concat(keywordTemp))].filter(element => element.trim() !== '');
            // 분리된 문자열 최종 출력
            // console.log(keywordTemp3);
        }

        // 주어진 배열을 1차원 배열로 만드는 함수 -> 재귀적 함수
        function flattenArray(arr) {
            let result = [];
            arr.forEach(element => {
                // 만약 요소가 배열인 경우 재귀적으로 결과 배열에 추가
                if(Array.isArray(element)) {
                    result = result.concat(flattenArray(element));
                } else {  // 요소가 배열이 아닌 경우 결과 배열에 직접 추가
                    result.push(element);
                }
            });
            return result;
        }

        // 역사에 이미 데이터가 존재하는지 확인
        async function data_check(){
            var docRefHistory = db.collection('history').doc($('#name').val() + "(" + $('#birthday').val() + ")");
            var subHistory = docRefHistory.collection('data').doc('count');

            subHistory.get().then((doc) => {
                if(doc.exists){
                    view_temp = doc.data().view;
                    like_temp = doc.data().like;
                    document_version = doc.data().version;
                    document_the_first_date = doc.data().the_first_date;
                    // console.log("exists 실행");
                }
                else{
                    // alert("NO");
                }
            }).catch((err) =>{
                console.log("data loading error : " + err);
            })
        }
            
        async function data_saving() {

            var file = document.querySelector('#profile_image_file').files[0];
            var storageRef = storage.ref();

            // 첨부파일 여부 확인
            var profilecover_chk = document.getElementById("profile_image_file").value;

            var docRef = db.collection('author_document').doc($('#name').val() + "(" + $('#birthday').val() + ")");

            // 첨부파일에 이미지가 없는 경우
            if (profilecover_chk.length === 0) {
                var dt = new Date();
                // console.log("이미지없음 실행");
                if ($('#name').val().length === 0) {
                    alert("제목이 입력되지 않았습니다.");
                } else if ($('#native').val().length === 0) {
                    alert("출생이 입력되지 않았습니다.");
                } else if ($('#birthday').val().length === 0) {
                    alert("생년월일이 입력되지 않았습니다.");
                } else if ($('#debutdate').val().length === 0) {
                    alert("등단일(데뷔일)이 입력되지 않았습니다.");
                } else if ($('#recent_publishdate').val().length === 0) {
                    alert("최근 출간일이 입력되지 않았습니다.");
                } else if ($('#main_novel').val().length === 0) {
                    alert("대표작품이 입력되지 않았습니다.");
                } else if ($('#recent_novel').val().length === 0) {
                    alert("최근작품이 입력되지 않았습니다.");
                } else if ($('#school').val().length === 0) {
                    alert("학력이 입력되지 않았습니다.");
                } else if ($('#company').val().length === 0) {
                    alert("소속이 입력되지 않았습니다.");
                } else if (tags.length === 0) {
                    alert("태그가 입력되지 않았습니다.");
                } else {
                    return await docRef.update({
                            name: $('#name').val(),
                            name_keyword: keywordTemp3,
                            native: $('#native').val(),
                            birthday: $('#birthday').val(),
                            debutdate: $('#debutdate').val(),
                            recent_publishdate: $('#recent_publishdate').val(),
                            main_novel: $('#main_novel').val(),
                            recent_novel: $('#recent_novel').val(),
                            school: $('#school').val(),
                            company: $('#company').val(),
                            tag: tags,
                            other: editor.innerHTML,
                            version: firebase.firestore.FieldValue.increment(1),
                            update_date: dt,
                            final_modify: ip_address_info,
                            user_class: user_class,
                        })
                        .then(async() => {
                            // console.log("Document successfully updated!");
                            await history_version_update();
                            await history(document_profilecover);
                            // window.location.href = '../a/' + $('#name').val() + "(" + $('#birthday').val() + ")";
                        })
                        .catch(async(error) => {
                            // The document probably doesn't exist.
                            // 새문서의 경우
                            console.error("Error updating document: ", error);
                            var info = {
                                profilecover: 'https://novelpedia2223-2ce3c.web.app/image/%ED%91%9C%EC%A7%80_%EB%AF%B8%EB%93%B1%EB%A1%9D.png',
                                name: $('#name').val(),
                                name_keyword: keywordTemp3,
                                native: $('#native').val(),
                                birthday: $('#birthday').val(),
                                debutdate: $('#debutdate').val(),
                                recent_publishdate: $('#recent_publishdate').val(),
                                main_novel: $('#main_novel').val(),
                                recent_novel: $('#recent_novel').val(),
                                school: $('#school').val(),
                                company: $('#company').val(),
                                tag: tags,
                                other: editor.innerHTML,
                                like: like_temp,
                                view: view_temp,
                                version:document_version + 1,
                                update_date: dt,
                                the_first_date: document_the_first_date,
                                category:"a",
                                final_modify: ip_address_info,
                                user_class: user_class,
                            };
                            await docRef.set(info).then(async(result) => {
                                // console.log(result);
                                await history_data();
                                await history(document_profilecover);
                                // alert("success.");
                                // window.location.href = '../a/' + $('#name').val() + "(" + $('#birthday').val() + ")";
                            }).catch((err) => {
                                alert("failed." + err);
                            });
                        });
                }
            } else {
                // console.log("이미지있음 실행");
                var dt = new Date();
                var dt_temp = dt.getFullYear() + (String)(dt.getMonth() + 1) + dt.getDate() + dt.getHours() + dt.getMinutes() + dt.getSeconds() + dt.getMilliseconds();
                // console.log(dt_temp);
                var save_path = storageRef.child('image/' + dt_temp + file.name);
                var uploading = save_path.put(file);

                if ($('#name').val().length === 0) {
                    alert("제목이 입력되지 않았습니다.");
                } else if ($('#native').val().length === 0) {
                    alert("출생이 입력되지 않았습니다.");
                } else if ($('#birthday').val().length === 0) {
                    alert("생년월일이 입력되지 않았습니다.");
                } else if ($('#debutdate').val().length === 0) {
                    alert("등단일(데뷔일)이 입력되지 않았습니다.");
                } else if ($('#recent_publishdate').val().length === 0) {
                    alert("최근 출간일이 입력되지 않았습니다.");
                } else if ($('#main_novel').val().length === 0) {
                    alert("대표작품이 입력되지 않았습니다.");
                } else if ($('#recent_novel').val().length === 0) {
                    alert("최근작품이 입력되지 않았습니다.");
                } else if ($('#school').val().length === 0) {
                    alert("학력이 입력되지 않았습니다.");
                } else if ($('#company').val().length === 0) {
                    alert("소속이 입력되지 않았습니다.");
                } else if (tags.length === 0) {
                    alert("태그가 입력되지 않았습니다.");
                } else {
                    await uploading.on('state_changed',
                        null,
                        (error) => {
                            console.error('fail reason: ', error);
                        },

                        () => {
                            uploading.snapshot.ref.getDownloadURL().then(async(url) => {
                                return await docRef.update({
                                        profilecover: url,
                                        name: $('#name').val(),
                                        name_keyword: keywordTemp3,
                                        native: $('#native').val(),
                                        birthday: $('#birthday').val(),
                                        debutdate: $('#debutdate').val(),
                                        recent_publishdate: $('#recent_publishdate').val(),
                                        main_novel: $('#main_novel').val(),
                                        recent_novel: $('#recent_novel').val(),
                                        school: $('#school').val(),
                                        company: $('#company').val(),
                                        tag: tags,
                                        other: editor.innerHTML,
                                        version: firebase.firestore.FieldValue.increment(1),
                                        update_date: dt,
                                        final_modify: ip_address_info,
                                        user_class: user_class,
                                    })
                                    .then(async() => {
                                        await history_version_update();
                                        await history(url);
                                        // window.location.href = '../a/' + $('#name').val() + "(" + $('#birthday').val() + ")";
                                        // console.log("Document successfully updated!");
                                    })
                                    .catch(async(error) => {
                                        // The document probably doesn't exist.
                                        console.error("Error updating document: ", error);
                                        var info = {
                                            profilecover: url,
                                            name: $('#name').val(),
                                            name_keyword: keywordTemp3,
                                            native: $('#native').val(),
                                            birthday: $('#birthday').val(),
                                            debutdate: $('#debutdate').val(),
                                            recent_publishdate: $('#recent_publishdate').val(),
                                            main_novel: $('#main_novel').val(),
                                            recent_novel: $('#recent_novel').val(),
                                            school: $('#school').val(),
                                            company: $('#company').val(),
                                            tag: tags,
                                            other: editor.innerHTML,
                                            like: like_temp,
                                            view: view_temp,
                                            version:document_version + 1,
                                            update_date: dt,
                                            the_first_date: document_the_first_date,
                                            category:"a",
                                            final_modify: ip_address_info,
                                            user_class: user_class,
                                        };
                                        await docRef.set(info).then(async(result) => {
                                            // console.log(result);
                                            await history_data();
                                            await history(url);                           
                                        }).catch((err) => {
                                            alert("failed." + err);
                                        });

                                    });
                            })
                        }
                    )
                }

            }
            // 입력여부 확인, 태그는 입력하지 않아도 통과

        }
    </script>

    <script>
        function isCheck(){
            var check = document.getElementById('birthday_check').checked;

            if(check == true){
                document.getElementById("birthday").value = '0001-01-01';
                document.getElementById("birthday").disabled = true;
            }
            else{
                document.getElementById("birthday").value = "";
                document.getElementById("birthday").disabled = false;
            }
        }
    </script>

    <!-- 역사_초기화 -->
    <script>        
        async function history(url = "https://novelpedia2223-2ce3c.web.app/image/%ED%91%9C%EC%A7%80_%EB%AF%B8%EB%93%B1%EB%A1%9D.png") {
            var docRefHistory = db.collection('history').doc($('#name').val() + "(" + $('#birthday').val() + ")");
            var subHistory = docRefHistory.collection('version').doc((document_version + 1).toString());
            var info = {
                profilecover: url,
                name: $('#name').val(),
                name_keyword: keywordTemp3,
                native: $('#native').val(),
                birthday: $('#birthday').val(),
                debutdate: $('#debutdate').val(),
                recent_publishdate: $('#recent_publishdate').val(),
                main_novel: $('#main_novel').val(),
                recent_novel: $('#recent_novel').val(),
                school: $('#school').val(),
                company: $('#company').val(),
                tag: tags,
                version: document_version + 1,
                other: editor.innerHTML,
                the_first_date: document_the_first_date,
                update_date:new Date(),
                category:document_category,
                final_modify: ip_address_info,
                user_class: user_class,
                action: "m",                               
            };
            await subHistory.set(info).then((result) => {
                // console.log(result);
                // alert("history success.");
                window.location.href = '../a/' + $('#name').val() + "(" + $('#birthday').val() + ")";
            }).catch((error) => {
                console.log(error);
                // alert("history failed.");
            });
        }

        async function history_version_update(){
            var docRefHistory = db.collection('history').doc($('#name').val() + "(" + $('#birthday').val() + ")");
            var subHistory = docRefHistory.collection('data').doc('count');
            return await subHistory.update({
                version: document_version + 1,
            }).then(() => {
                // console.log("역사 버전 업데이트 성공");
            }).catch((error) => {
                console.log(error);
            });
        }

        // 역사 data 최초 저장
        async function history_data() {
            var docRefHistory = db.collection('history').doc($('#name').val() + "(" + $('#birthday').val() + ")");
            var subHistory = docRefHistory.collection('data').doc('count');
            var info = {
                version:document_version + 1,
                view:view_temp,
                like:like_temp,
                the_first_date: document_the_first_date,                         
            };
            await subHistory.set(info).then((result) => {
                // console.log(result);
                // alert("history data success.");
            }).catch((error) => {
                console.log(error);
                // alert("history data failed.");
            });
        }
    </script>

    <script>
        var user_class = "nu";

        $('#go_delete').click(function(){
            if(confirm("정말 '" + document_name[2] + "'문서를 삭제하시겠습니까?")){
                $('#loading_box').show()
                db.collection('author_document').doc(document_name[2]).delete().then(async function() {
                    if(login_check == true){
                        ip_address_info = user_id;
                        user_class = login_user_class;
                    }
                    await history_data_update();
                    await history_update();
                    // console.log("문서 삭제 완료");
                    $('#loading_box').hide()
                }).catch(function(error) {
                    console.error("Error removing document: ", error);
                });
            }
            else{

            }
        });

        async function history_data_update(){
            return await db.collection('history').doc(document_name[2]).collection('data').doc('count').update({
                version: firebase.firestore.FieldValue.increment(1),
            })
            .then(async () => {
                // alert("history data 업데이트 성공!");                
            }).catch((err)=>{
                console.log(err + "history data 업데이트 실패!")
            });
        }

        async function history_update(){
            var info = {
                profilecover: data_save_array.data().profilecover,
                name: data_save_array.data().name,
                name_keyword: data_save_array.data().name_keyword,
                native: data_save_array.data().native,
                birthday: data_save_array.data().birthday,
                debutdate: data_save_array.data().debutdate,
                recent_publishdate: data_save_array.data().recent_publishdate,
                main_novel: data_save_array.data().main_novel,
                recent_novel: data_save_array.data().recent_novel,
                school: data_save_array.data().school,
                company: data_save_array.data().company,
                tag: data_save_array.data().tag,
                other: data_save_array.data().other,
                the_first_date: data_save_array.data().the_first_date,
                version: data_save_array.data().version + 1,
                update_date:new Date(),
                category: data_save_array.data().category,
                final_modify: ip_address_info,
                user_class: user_class,
                action: "d",                               
            };
            // console.log(document_name[2]);
            await db.collection('history').doc(document_name[2]).collection('version').doc((data_save_array.data().version + 1).toString()).set(info).then((result) => {
                // console.log(result);
                // alert("history data success.");
                location.reload();
            }).catch((error) => {
                console.log(error);
                // alert("history data failed.");
            });

        }
    </script>
</body>

</html>